name: CI Tests

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']
  workflow_dispatch:

# „Ç≠„É£„É≥„Çª„É´Ë®≠ÂÆö: Âêå„Åò„Éñ„É©„É≥„ÉÅ„ÅßÊñ∞„Åó„ÅÑ„Éó„ÉÉ„Ç∑„É•„Åå„ÅÇ„Å£„ÅüÂ†¥Âêà„ÄÅÂÆüË°å‰∏≠„ÅÆ„ÉØ„Éº„ÇØ„Éï„É≠„Éº„Çí„Ç≠„É£„É≥„Çª„É´
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =============================================
  # Lint Job - „Ç≥„Éº„ÉâÂìÅË≥™„ÉÅ„Çß„ÉÉ„ÇØ
  # =============================================
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint
        continue-on-error: false

      - name: Check for JavaScript syntax errors
        run: |
          echo "Checking JavaScript syntax..."
          for file in *.js scripts/*.js; do
            if [ -f "$file" ]; then
              echo "Checking $file"
              node -c "$file" || exit 1
            fi
          done

  # =============================================
  # Validate Job - Ë®≠ÂÆö„Éï„Ç°„Ç§„É´„ÅÆÊ§úË®º
  # =============================================
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run configuration validation
        run: npm run validate
        continue-on-error: true

      - name: Check required files
        run: |
          echo "Checking for required files..."
          files=(
            "index.html"
            "app.js"
            "styles.css"
            "supabase-config.js"
            "supabase-integration.js"
          )
          for file in "${files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå Missing required file: $file"
              exit 1
            else
              echo "‚úÖ Found: $file"
            fi
          done

  # =============================================
  # Test Job - Ëá™Âãï„ÉÜ„Çπ„ÉàÂÆüË°åÔºà„Éû„Éà„É™„ÇØ„ÇπÊà¶Áï•Ôºâ
  # =============================================
  test:
    name: Test (Node ${{ matrix.node-version }} on ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        node-version: ['18', '20', '22']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-node-${{ matrix.node-version }}-${{ matrix.os }}
          path: |
            test-results/
            coverage/
          retention-days: 30
          if-no-files-found: ignore

  # =============================================
  # Security Job - „Çª„Ç≠„É•„É™„ÉÜ„Ç£Áõ£Êüª
  # =============================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Check for secrets
        run: |
          echo "Checking for potential secrets in code..."
          echo "Note: supabase-config.js contains frontend config (anon key is safe to expose)"

          # Check for secrets in backend scripts (excluding supabase-config.js)
          if grep -r "SUPABASE.*KEY.*eyJ" --include="*.js" --exclude="supabase-config.js" . | grep -v "node_modules" | grep -v "process.env"; then
            echo "‚ùå Error: Found hardcoded API keys in backend scripts!"
            exit 1
          fi

          echo "‚úÖ No hardcoded secrets found in backend scripts"

  # =============================================
  # Build Job - „Éì„É´„ÉâÊ§úË®º
  # =============================================
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [lint, validate]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run build
        run: npm run build

      - name: Verify build artifacts
        run: |
          echo "‚úÖ Build completed successfully"
          ls -lah

  # =============================================
  # File Structure Job - „Éï„Ç°„Ç§„É´ÊßãÈÄ†„ÉÅ„Çß„ÉÉ„ÇØ
  # =============================================
  file-structure:
    name: File Structure Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Supabase structure
        run: |
          echo "Checking Supabase directory structure..."
          required_dirs=(
            "supabase/migrations"
            "supabase/functions"
          )
          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "‚ùå Missing directory: $dir"
              exit 1
            else
              echo "‚úÖ Found: $dir"
            fi
          done

      - name: Check migration files
        run: |
          echo "Checking migration files..."
          if [ ! -d "supabase/migrations" ] || [ -z "$(ls -A supabase/migrations/*.sql 2>/dev/null)" ]; then
            echo "‚ö†Ô∏è Warning: No migration files found"
          else
            echo "‚úÖ Migration files found:"
            ls -lh supabase/migrations/*.sql
          fi

      - name: Check Edge Functions
        run: |
          echo "Checking Edge Functions..."
          functions=(
            "generate-article"
            "analyze-seo"
            "check-quality"
            "generate-images"
          )
          for func in "${functions[@]}"; do
            if [ ! -f "supabase/functions/$func/index.ts" ]; then
              echo "‚ùå Missing function: $func"
              exit 1
            else
              echo "‚úÖ Found function: $func"
            fi
          done

  # =============================================
  # Documentation Job - „Éâ„Ç≠„É•„É°„É≥„Éà„ÉÅ„Çß„ÉÉ„ÇØ
  # =============================================
  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check documentation files
        run: |
          echo "Checking documentation files..."
          docs=(
            "README.md"
            "SETUP_REQUIRED.md"
          )
          for doc in "${docs[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "‚ùå Missing documentation: $doc"
              exit 1
            else
              echo "‚úÖ Found: $doc"
              word_count=$(wc -w < "$doc")
              echo "   Word count: $word_count"
              if [ "$word_count" -lt 100 ]; then
                echo "   ‚ö†Ô∏è Warning: Documentation seems incomplete"
              fi
            fi
          done

      - name: Check for TODO comments
        run: |
          echo "Checking for TODO/FIXME comments..."
          if grep -r "TODO\|FIXME" --include="*.js" --include="*.ts" .; then
            echo "‚ö†Ô∏è Found TODO/FIXME comments in code"
          else
            echo "‚úÖ No TODO/FIXME comments found"
          fi

  # =============================================
  # Summary Job - „ÉÜ„Çπ„ÉàÁµêÊûú„Çµ„Éû„É™„Éº
  # =============================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [lint, validate, test, security, build, file-structure, documentation]
    if: always()

    steps:
      - name: Check job results
        run: |
          echo "=========================================="
          echo "üìä CI Test Results Summary"
          echo "=========================================="
          echo ""
          echo "Lint: ${{ needs.lint.result }}"
          echo "Validate: ${{ needs.validate.result }}"
          echo "Test: ${{ needs.test.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Build: ${{ needs.build.result }}"
          echo "File Structure: ${{ needs.file-structure.result }}"
          echo "Documentation: ${{ needs.documentation.result }}"
          echo ""

          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ]; then
            echo "‚ùå Some critical tests failed"
            exit 1
          else
            echo "‚úÖ All critical tests passed!"
          fi
