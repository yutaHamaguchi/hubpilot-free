<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>HubPilot Free - SEO記事作成エージェント</title>
    <link rel="stylesheet" href="./styles.css">
    <link rel="stylesheet" href="./image-generation-styles.css">
    <link rel="stylesheet" href="./auth-styles.css">
    <link rel="stylesheet" href="./wordpress-styles.css">
</head>
<body>
    <!-- 認証オーバーレイ（一時的に無効化） -->
    <div id="auth-overlay" class="auth-overlay hidden">
        <div class="auth-card">
            <!-- ヘッダー -->
            <div class="auth-header">
                <div class="auth-logo">🚀</div>
                <h2>HubPilot Free</h2>
                <p class="auth-subtitle">AI記事作成エージェント</p>
            </div>

            <!-- 通知メッセージ -->
            <div id="auth-message" class="auth-message"></div>

            <!-- タブ切替 -->
            <div class="auth-tabs">
                <button class="active" data-tab="signin" onclick="switchAuthTab('signin')">
                    ログイン
                </button>
                <button data-tab="signup" onclick="switchAuthTab('signup')">
                    新規登録
                </button>
            </div>

            <!-- ログインフォーム -->
            <form id="signin-form" class="auth-form active" onsubmit="handleSignIn(event)">
                <div class="form-group">
                    <label for="signin-email">メールアドレス</label>
                    <input
                        type="email"
                        id="signin-email"
                        placeholder="your@email.com"
                        required
                        autocomplete="email"
                    >
                </div>

                <div class="form-group">
                    <label for="signin-password">パスワード</label>
                    <input
                        type="password"
                        id="signin-password"
                        placeholder="••••••••"
                        required
                        autocomplete="current-password"
                    >
                    <div class="password-reset-link">
                        <button type="button" onclick="showPasswordReset()">
                            パスワードを忘れた方
                        </button>
                    </div>
                </div>

                <button type="submit" class="auth-button" id="signin-button">
                    ログイン
                </button>
            </form>

            <!-- 新規登録フォーム -->
            <form id="signup-form" class="auth-form" onsubmit="handleSignUp(event)">
                <div class="form-group">
                    <label for="signup-name">表示名（オプション）</label>
                    <input
                        type="text"
                        id="signup-name"
                        placeholder="山田太郎"
                        autocomplete="name"
                    >
                </div>

                <div class="form-group">
                    <label for="signup-email">メールアドレス</label>
                    <input
                        type="email"
                        id="signup-email"
                        placeholder="your@email.com"
                        required
                        autocomplete="email"
                    >
                </div>

                <div class="form-group">
                    <label for="signup-password">パスワード（8文字以上）</label>
                    <input
                        type="password"
                        id="signup-password"
                        placeholder="••••••••"
                        required
                        minlength="8"
                        autocomplete="new-password"
                    >
                </div>

                <div class="form-group">
                    <label for="signup-password-confirm">パスワード確認</label>
                    <input
                        type="password"
                        id="signup-password-confirm"
                        placeholder="••••••••"
                        required
                        minlength="8"
                        autocomplete="new-password"
                    >
                    <div id="password-error" class="form-error"></div>
                </div>

                <button type="submit" class="auth-button" id="signup-button">
                    新規登録
                </button>
            </form>

            <!-- ソーシャルログイン -->
            <div class="social-login">
                <div class="social-login-title">または</div>

                <button class="social-button" onclick="handleSocialLogin('google')">
                    <svg width="20" height="20" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Googleでログイン
                </button>

                <button class="social-button" onclick="handleSocialLogin('github')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="#333">
                        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                    </svg>
                    GitHubでログイン
                </button>
            </div>

            <!-- ゲストログイン -->
            <div class="guest-login">
                <button class="link-button" onclick="handleGuestLogin()">
                    ゲストとして続ける（データはローカルのみ保存）
                </button>
            </div>
        </div>
    </div>

    <!-- メインアプリケーション（認証なしで直接表示） -->
    <div id="main-app" class="">
        <!-- 全体プログレスバー -->
        <div class="overall-progress-container">
            <div class="overall-progress"></div>
        </div>

        <div class="app-container">
        <!-- サイドバー（ステップインジケーター） -->
        <aside class="sidebar">
            <div class="logo">
                <h1>HubPilot Free</h1>
                <p>SEO記事作成エージェント</p>

                <!-- データ管理メニュー -->
                <div class="data-management">
                    <button class="btn btn-small btn-secondary" id="data-menu-btn" title="データ管理">
                        <span class="btn-icon">⚙️</span>
                    </button>

                    <div class="data-menu" id="data-menu" style="display: none;">
                        <div class="menu-item" onclick="app.exportData()">
                            <span class="menu-icon">📤</span>
                            <span>データをエクスポート</span>
                        </div>
                        <div class="menu-item" onclick="document.getElementById('import-file').click()">
                            <span class="menu-icon">📥</span>
                            <span>データをインポート</span>
                        </div>
                        <div class="menu-item" onclick="app.showBackupList()">
                            <span class="menu-icon">🔄</span>
                            <span>バックアップ管理</span>
                        </div>
                        <div class="menu-item" onclick="app.showStorageInfo()">
                            <span class="menu-icon">💾</span>
                            <span>ストレージ情報</span>
                        </div>
                        <div class="menu-item danger" onclick="app.confirmResetData()">
                            <span class="menu-icon">🗑️</span>
                            <span>データをリセット</span>
                        </div>
                    </div>

                    <input type="file" id="import-file" accept=".json" style="display: none;">
                </div>
            </div>

            <nav class="step-navigation">
                <div class="step-item active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-info">
                        <h3>テーマ設定</h3>
                        <p>メインテーマを入力</p>
                    </div>
                </div>

                <div class="step-item" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-info">
                        <h3>構成案確認</h3>
                        <p>ピラー・クラスター構成</p>
                    </div>
                </div>

                <div class="step-item" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-info">
                        <h3>見出し構成</h3>
                        <p>各記事の見出し設定</p>
                    </div>
                </div>

                <div class="step-item" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-info">
                        <h3>記事執筆</h3>
                        <p>コンテンツ生成進捗</p>
                    </div>
                </div>

                <div class="step-item" data-step="5">
                    <div class="step-number">5</div>
                    <div class="step-info">
                        <h3>品質チェック</h3>
                        <p>記事の品質確認</p>
                    </div>
                </div>

                <div class="step-item" data-step="6">
                    <div class="step-number">6</div>
                    <div class="step-info">
                        <h3>最終承認</h3>
                        <p>ピラーページ統合</p>
                    </div>
                </div>
            </nav>
        </aside>

        <!-- メインコンテンツエリア -->
        <main class="main-content">
            <div class="content-wrapper">
                <!-- ステップ1: テーマ設定 -->
                <div class="step-content active" id="step-1">
                    <div class="step-header">
                        <h2>メインテーマを設定してください</h2>
                        <p>あなたのコンテンツ戦略の中心となるテーマを入力してください。<br>
                        このテーマから、1つのピラーページと10個のクラスターページを自動生成します。</p>
                    </div>

                    <div class="input-section">
                        <div class="theme-input-container">
                            <label for="theme-input" class="input-label">
                                コンテンツテーマ
                                <span class="required-mark">*</span>
                            </label>

                            <div class="input-wrapper">
                                <input
                                    type="text"
                                    id="theme-input"
                                    class="theme-input"
                                    placeholder="例：Instagramマーケティング"
                                    maxlength="100"
                                    autocomplete="off"
                                />
                                <div class="input-icon">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M9 12l2 2 4-4"></path>
                                        <path d="M21 12c-1 0-3-1-3-3s2-3 3-3 3 1 3 3-2 3-3 3"></path>
                                        <path d="M3 12c1 0 3-1 3-3s-2-3-3-3-3 1-3 3 2 3 3 3"></path>
                                    </svg>
                                </div>
                            </div>

                            <div class="input-help">
                                <div class="character-count">
                                    <span id="char-count">0</span>/100文字
                                </div>
                            </div>

                            <div class="input-error" id="theme-error"></div>
                        </div>

                        <!-- テーマ例の表示 -->
                        <div class="theme-examples">
                            <h4>テーマ例</h4>
                            <div class="examples-grid">
                                <button class="example-btn" data-theme="Instagramマーケティング">
                                    <span class="example-icon">📱</span>
                                    <span class="example-text">Instagramマーケティング</span>
                                </button>
                                <button class="example-btn" data-theme="SEO対策">
                                    <span class="example-icon">🔍</span>
                                    <span class="example-text">SEO対策</span>
                                </button>
                                <button class="example-btn" data-theme="コンテンツマーケティング">
                                    <span class="example-icon">📝</span>
                                    <span class="example-text">コンテンツマーケティング</span>
                                </button>
                                <button class="example-btn" data-theme="Webデザイン">
                                    <span class="example-icon">🎨</span>
                                    <span class="example-text">Webデザイン</span>
                                </button>
                                <button class="example-btn" data-theme="デジタルマーケティング">
                                    <span class="example-icon">💻</span>
                                    <span class="example-text">デジタルマーケティング</span>
                                </button>
                                <button class="example-btn" data-theme="ブランディング">
                                    <span class="example-icon">✨</span>
                                    <span class="example-text">ブランディング</span>
                                </button>
                            </div>
                        </div>

                        <div class="action-section">
                            <button class="btn btn-primary btn-large" id="generate-structure-btn" disabled>
                                <span class="btn-icon">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                                    </svg>
                                </span>
                                構成案を作成
                            </button>

                            <div class="action-help">
                                <p>💡 入力したテーマから、SEOに最適化された記事構成を自動生成します</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ステップ2: 構成案確認 -->
                <div class="step-content" id="step-2">
                    <div class="step-header">
                        <h2>構成案を確認してください</h2>
                        <p>生成された構成案を確認し、必要に応じて編集してください。<br>
                        この構成に基づいて、SEOに最適化された記事群を作成します。</p>
                    </div>

                    <div class="structure-section">
                        <!-- ピラーページセクション -->
                        <div class="pillar-page-section">
                            <div class="section-header">
                                <h3>
                                    <span class="section-icon">🏛️</span>
                                    ピラーページ
                                </h3>
                                <div class="section-badge">メイン記事</div>
                            </div>

                            <div class="pillar-page-card">
                                <div class="pillar-page-title" id="pillar-page-title">
                                    <!-- ピラーページタイトルがここに表示される -->
                                </div>
                                <div class="pillar-page-actions">
                                    <button class="btn btn-small btn-secondary" id="edit-pillar-btn">
                                        <span class="btn-icon">✏️</span>
                                        編集
                                    </button>
                                </div>
                            </div>

                            <div class="pillar-page-info">
                                <p>💡 ピラーページは、テーマ全体を包括的にカバーする中心的な記事です。</p>
                            </div>
                        </div>

                        <!-- クラスターページセクション -->
                        <div class="cluster-pages-section">
                            <div class="section-header">
                                <h3>
                                    <span class="section-icon">📚</span>
                                    クラスターページ
                                </h3>
                                <div class="section-badge">10記事</div>
                            </div>

                            <div class="cluster-pages-controls">
                                <div class="controls-left">
                                    <button class="btn btn-small btn-secondary" id="add-cluster-btn">
                                        <span class="btn-icon">➕</span>
                                        記事を追加
                                    </button>
                                    <button class="btn btn-small btn-secondary" id="regenerate-cluster-btn">
                                        <span class="btn-icon">🔄</span>
                                        再生成
                                    </button>
                                </div>
                                <div class="controls-right">
                                    <span class="cluster-count">
                                        <span id="cluster-count">10</span>記事
                                    </span>
                                </div>
                            </div>

                            <div class="cluster-pages-list" id="cluster-pages-list">
                                <!-- クラスターページリストがここに表示される -->
                            </div>

                            <div class="cluster-pages-info">
                                <p>💡 クラスターページは、ピラーページの各トピックを詳しく解説する専門記事です。</p>
                            </div>
                        </div>

                        <!-- アクションセクション -->
                        <div class="action-section">
                            <div class="structure-summary">
                                <div class="summary-item">
                                    <span class="summary-icon">🏛️</span>
                                    <span class="summary-text">ピラーページ: 1記事</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-icon">📚</span>
                                    <span class="summary-text">クラスターページ: <span id="summary-cluster-count">10</span>記事</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-icon">📊</span>
                                    <span class="summary-text">合計: <span id="summary-total-count">11</span>記事</span>
                                </div>
                            </div>

                            <button class="btn btn-primary btn-large" id="proceed-to-headings-btn">
                                <span class="btn-icon">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M9 18l6-6-6-6"></path>
                                    </svg>
                                </span>
                                この構成で進める
                            </button>

                            <div class="action-help">
                                <p>🚀 次のステップで、各記事の見出し構成を設定します</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ステップ3: 見出し構成 -->
                <div class="step-content" id="step-3">
                    <div class="step-header">
                        <h2>見出し構成を確認してください</h2>
                        <p>各クラスターページの見出し構成を確認し、必要に応じて編集してください。<br>
                        この見出し構成に基づいて、SEOに最適化された記事を生成します。</p>
                    </div>

                    <div class="headings-section">
                        <!-- 見出し構成の統計 -->
                        <div class="headings-stats">
                            <div class="stats-item">
                                <span class="stats-icon">📚</span>
                                <span class="stats-text">
                                    <strong id="total-articles">10</strong>記事
                                </span>
                            </div>
                            <div class="stats-item">
                                <span class="stats-icon">📝</span>
                                <span class="stats-text">
                                    <strong id="total-headings">40</strong>見出し
                                </span>
                            </div>
                            <div class="stats-item">
                                <span class="stats-icon">⏱️</span>
                                <span class="stats-text">
                                    約<strong id="estimated-time">25</strong>分で生成
                                </span>
                            </div>
                        </div>

                        <!-- 見出し構成コントロール -->
                        <div class="headings-controls">
                            <div class="controls-left">
                                <button class="btn btn-small btn-secondary" id="expand-all-btn">
                                    <span class="btn-icon">📖</span>
                                    すべて展開
                                </button>
                                <button class="btn btn-small btn-secondary" id="collapse-all-btn">
                                    <span class="btn-icon">📕</span>
                                    すべて折りたたみ
                                </button>
                                <button class="btn btn-small btn-secondary" id="regenerate-headings-btn">
                                    <span class="btn-icon">🔄</span>
                                    見出し再生成
                                </button>
                            </div>
                            <div class="controls-right">
                                <div class="view-toggle">
                                    <button class="toggle-btn active" data-view="accordion">
                                        <span class="btn-icon">📋</span>
                                        アコーディオン
                                    </button>
                                    <button class="toggle-btn" data-view="list">
                                        <span class="btn-icon">📄</span>
                                        リスト
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- アコーディオンビュー -->
                        <div class="headings-accordion" id="headings-accordion">
                            <!-- 見出し構成がここに表示される -->
                        </div>

                        <!-- リストビュー -->
                        <div class="headings-list-view" id="headings-list-view" style="display: none;">
                            <!-- リスト形式の見出し構成がここに表示される -->
                        </div>

                        <!-- アクションセクション -->
                        <div class="action-section">
                            <div class="headings-summary">
                                <div class="summary-card">
                                    <h4>📊 構成サマリー</h4>
                                    <div class="summary-grid">
                                        <div class="summary-item">
                                            <span class="summary-label">平均見出し数</span>
                                            <span class="summary-value" id="avg-headings">4.0</span>
                                        </div>
                                        <div class="summary-item">
                                            <span class="summary-label">推定文字数</span>
                                            <span class="summary-value" id="estimated-words">20,000</span>
                                        </div>
                                        <div class="summary-item">
                                            <span class="summary-label">SEO最適化</span>
                                            <span class="summary-value">✅ 完了</span>
                                        </div>
                                        <div class="summary-item">
                                            <span class="summary-label">内部リンク</span>
                                            <span class="summary-value" id="internal-links">45</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button class="btn btn-primary btn-large" id="start-writing-btn">
                                <span class="btn-icon">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                                    </svg>
                                </span>
                                記事執筆を開始（時間がかかります）
                            </button>

                            <div class="action-help">
                                <p>🚀 次のステップで、各記事の本文を自動生成します</p>
                                <p>💡 生成には約25分かかります。途中でブラウザを閉じないでください。</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ステップ4: 記事執筆進捗 -->
                <div class="step-content" id="step-4">
                    <div class="step-header">
                        <h2>記事を執筆中です</h2>
                        <p>AIが各記事の本文を生成しています。生成には時間がかかりますが、しばらくお待ちください。<br>
                        生成が完了した記事から順次プレビューできます。</p>
                    </div>

                    <div class="progress-section">
                        <!-- 全体進捗表示 -->
                        <div class="overall-progress-card">
                            <div class="progress-header">
                                <h3>
                                    <span class="progress-icon">⚡</span>
                                    記事生成進捗
                                </h3>
                                <div class="progress-status" id="progress-status">準備中...</div>
                            </div>

                            <div class="progress-bar-container">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progress-fill"></div>
                                    <div class="progress-percentage" id="progress-percentage">0%</div>
                                </div>
                                <div class="progress-text" id="progress-text">記事 0/10 を作成中...</div>
                            </div>

                            <div class="progress-stats">
                                <div class="stat-item">
                                    <span class="stat-icon">✅</span>
                                    <span class="stat-text">
                                        完了: <strong id="completed-count">0</strong>記事
                                    </span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-icon">⏳</span>
                                    <span class="stat-text">
                                        残り: <strong id="remaining-count">10</strong>記事
                                    </span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-icon">🕒</span>
                                    <span class="stat-text">
                                        推定残り時間: <strong id="estimated-remaining">25分</strong>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- 記事生成コントロール -->
                        <div class="generation-controls">
                            <div class="controls-left">
                                <button class="btn btn-small btn-secondary" id="pause-generation-btn" style="display: none;">
                                    <span class="btn-icon">⏸️</span>
                                    一時停止
                                </button>
                                <button class="btn btn-small btn-secondary" id="resume-generation-btn" style="display: none;">
                                    <span class="btn-icon">▶️</span>
                                    再開
                                </button>
                                <button class="btn btn-small btn-secondary" id="cancel-generation-btn" style="display: none;">
                                    <span class="btn-icon">⏹️</span>
                                    キャンセル
                                </button>
                            </div>
                            <div class="controls-right">
                                <div class="generation-speed">
                                    <span class="speed-label">生成速度:</span>
                                    <span class="speed-value" id="generation-speed">2.4記事/分</span>
                                </div>
                            </div>
                        </div>

                        <!-- 記事カードグリッド -->
                        <div class="articles-grid" id="articles-grid">
                            <!-- 記事カードがここに表示される -->
                        </div>

                        <!-- 完了アクション -->
                        <div class="completion-section" id="completion-section" style="display: none;">
                            <div class="completion-card">
                                <div class="completion-icon">🎉</div>
                                <h3>記事生成が完了しました！</h3>
                                <p>全<span id="total-generated">10</span>記事の生成が正常に完了しました。次のステップで品質チェックを行います。</p>

                                <div class="completion-stats">
                                    <div class="completion-stat">
                                        <span class="stat-number" id="total-words">20,000</span>
                                        <span class="stat-label">総文字数</span>
                                    </div>
                                    <div class="completion-stat">
                                        <span class="stat-number" id="total-time">24分</span>
                                        <span class="stat-label">生成時間</span>
                                    </div>
                                    <div class="completion-stat">
                                        <span class="stat-number">100%</span>
                                        <span class="stat-label">成功率</span>
                                    </div>
                                </div>

                                <button class="btn btn-primary btn-large" id="proceed-to-quality-btn">
                                    <span class="btn-icon">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M9 12l2 2 4-4"></path>
                                            <circle cx="12" cy="12" r="10"></circle>
                                        </svg>
                                    </span>
                                    品質チェックへ進む
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ステップ5: 品質チェック -->
                <div class="step-content" id="step-5">
                    <div class="step-header">
                        <h2>品質チェック</h2>
                        <p>生成された記事の品質をAIが自動チェックしています。<br>
                        問題が検出された記事については、修正提案を確認して改善してください。</p>
                    </div>

                    <div class="quality-check-section">
                        <!-- 品質チェック統計 -->
                        <div class="quality-stats-card">
                            <div class="stats-header">
                                <h3>
                                    <span class="stats-icon">🔍</span>
                                    品質チェック結果
                                </h3>
                                <div class="check-status" id="check-status">チェック中...</div>
                            </div>

                            <div class="quality-overview">
                                <div class="overview-item success">
                                    <div class="overview-number" id="passed-count">0</div>
                                    <div class="overview-label">合格</div>
                                </div>
                                <div class="overview-item warning">
                                    <div class="overview-number" id="warning-count">0</div>
                                    <div class="overview-label">要注意</div>
                                </div>
                                <div class="overview-item error">
                                    <div class="overview-number" id="failed-count">0</div>
                                    <div class="overview-label">要修正</div>
                                </div>
                            </div>

                            <div class="quality-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="quality-progress-fill"></div>
                                </div>
                                <div class="progress-text" id="quality-progress-text">品質チェック 0/10 完了</div>
                            </div>
                        </div>

                        <!-- 品質チェックコントロール -->
                        <div class="quality-controls">
                            <div class="controls-left">
                                <button class="btn btn-small btn-secondary" id="recheck-all-btn">
                                    <span class="btn-icon">🔄</span>
                                    全記事再チェック
                                </button>
                                <button class="btn btn-small btn-secondary" id="auto-fix-btn">
                                    <span class="btn-icon">🛠️</span>
                                    自動修正
                                </button>
                                <button class="btn btn-small btn-secondary" id="export-report-btn">
                                    <span class="btn-icon">📊</span>
                                    レポート出力
                                </button>
                            </div>
                            <div class="controls-right">
                                <div class="filter-toggle">
                                    <button class="filter-btn active" data-filter="all">すべて</button>
                                    <button class="filter-btn" data-filter="passed">合格</button>
                                    <button class="filter-btn" data-filter="warning">要注意</button>
                                    <button class="filter-btn" data-filter="failed">要修正</button>
                                </div>
                            </div>
                        </div>

                        <!-- 品質チェック結果リスト -->
                        <div class="quality-results" id="quality-results">
                            <!-- 品質チェック結果がここに表示される -->
                        </div>

                        <!-- アクションセクション -->
                        <div class="action-section">
                            <div class="quality-summary">
                                <div class="summary-card">
                                    <h4>📋 品質サマリー</h4>
                                    <div class="summary-grid">
                                        <div class="summary-item">
                                            <span class="summary-label">平均品質スコア</span>
                                            <span class="summary-value" id="avg-quality-score">85%</span>
                                        </div>
                                        <div class="summary-item">
                                            <span class="summary-label">SEO最適化率</span>
                                            <span class="summary-value" id="seo-optimization">92%</span>
                                        </div>
                                        <div class="summary-item">
                                            <span class="summary-label">読みやすさ</span>
                                            <span class="summary-value" id="readability-score">良好</span>
                                        </div>
                                        <div class="summary-item">
                                            <span class="summary-label">推定改善時間</span>
                                            <span class="summary-value" id="improvement-time">15分</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button class="btn btn-primary btn-large" id="create-pillar-btn">
                                <span class="btn-icon">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                        <polyline points="14,2 14,8 20,8"></polyline>
                                        <line x1="16" y1="13" x2="8" y2="13"></line>
                                        <line x1="16" y1="17" x2="8" y2="17"></line>
                                        <polyline points="10,9 9,9 8,9"></polyline>
                                    </svg>
                                </span>
                                ピラーページを作成して統合
                            </button>

                            <div class="action-help">
                                <p>🚀 次のステップで、すべての記事を統合したピラーページを作成します</p>
                                <p>💡 品質に問題がある記事も統合されますが、後から個別に修正できます</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ステップ6: 最終承認 -->
                <div class="step-content" id="step-6">
                    <div class="step-header">
                        <h2>最終承認</h2>
                        <p>ピラーページが完成しました。内容を確認してから公開してください。<br>
                        すべての記事が統合され、SEOに最適化されたコンテンツ群が完成しています。</p>
                    </div>

                    <div class="final-approval-section">
                        <!-- 完成統計 -->
                        <div class="completion-stats-card">
                            <div class="stats-header">
                                <h3>
                                    <span class="stats-icon">📊</span>
                                    完成統計
                                </h3>
                                <div class="completion-badge">完了</div>
                            </div>

                            <div class="completion-overview">
                                <div class="completion-item">
                                    <div class="completion-number" id="final-total-articles">11</div>
                                    <div class="completion-label">総記事数</div>
                                </div>
                                <div class="completion-item">
                                    <div class="completion-number" id="final-total-words">22,000</div>
                                    <div class="completion-label">総文字数</div>
                                </div>
                                <div class="completion-item">
                                    <div class="completion-number" id="final-avg-quality">87点</div>
                                    <div class="completion-label">平均品質</div>
                                </div>
                                <div class="completion-item">
                                    <div class="completion-number" id="final-seo-score">92%</div>
                                    <div class="completion-label">SEO最適化</div>
                                </div>
                            </div>
                        </div>

                        <!-- ピラーページプレビュー -->
                        <div class="pillar-preview-card">
                            <div class="preview-header">
                                <h3>
                                    <span class="preview-icon">🏛️</span>
                                    ピラーページプレビュー
                                </h3>
                                <div class="preview-actions">
                                    <button class="btn btn-small btn-secondary" id="edit-pillar-preview-btn">
                                        <span class="btn-icon">✏️</span>
                                        編集
                                    </button>
                                    <button class="btn btn-small btn-secondary" id="preview-fullscreen-btn">
                                        <span class="btn-icon">🔍</span>
                                        全画面表示
                                    </button>
                                </div>
                            </div>

                            <div class="pillar-preview-content" id="pillar-preview">
                                <!-- ピラーページプレビューがここに表示される -->
                            </div>
                        </div>

                        <!-- 内部リンク構造の視覚化 -->
                        <div class="link-structure-card">
                            <div class="structure-header">
                                <h3>
                                    <span class="structure-icon">🔗</span>
                                    内部リンク構造
                                </h3>
                                <div class="structure-toggle">
                                    <button class="btn btn-small btn-secondary" id="toggle-structure-btn">
                                        <span class="btn-icon">👁️</span>
                                        表示切替
                                    </button>
                                </div>
                            </div>

                            <div class="link-structure-visual" id="link-structure-visual">
                                <!-- 内部リンク構造の視覚化がここに表示される -->
                            </div>
                        </div>

                        <!-- 画像生成セクション -->
                        <div class="image-generation-card">
                            <div class="image-gen-header">
                                <h3>
                                    <span class="image-gen-icon">🎨</span>
                                    記事画像の自動生成
                                </h3>
                                <div class="image-gen-status">
                                    <span class="status-badge" id="image-gen-status">未生成</span>
                                </div>
                            </div>

                            <div class="image-gen-description">
                                <p>各記事にヒーロー画像と説明画像（2〜3枚）を自動生成します。</p>
                                <p>AIが記事内容を分析し、適切な画像を生成してMarkdownに自動挿入します。</p>
                            </div>

                            <div class="image-gen-options">
                                <div class="option-row">
                                    <label class="checkbox-label">
                                        <input type="checkbox" checked id="generate-hero">
                                        <span>ヒーロー画像を生成（1枚/記事）</span>
                                    </label>
                                    <span class="option-info">記事のメイン画像</span>
                                </div>

                                <div class="option-row">
                                    <label class="checkbox-label">
                                        <input type="checkbox" checked id="generate-illustrations">
                                        <span>説明画像を生成</span>
                                    </label>
                                    <select id="illustration-count" class="illustration-count-select">
                                        <option value="2">2枚/記事</option>
                                        <option value="3" selected>3枚/記事</option>
                                    </select>
                                </div>

                                <div class="option-row">
                                    <label class="select-label">
                                        <span>画像生成プロバイダー:</span>
                                        <select id="image-provider" class="provider-select">
                                            <option value="auto">自動選択（コスト最適化）</option>
                                            <option value="dalle3">DALL-E 3（高品質 - $0.20/記事）</option>
                                            <option value="stability">Stability AI（低コスト - $0.04/記事）</option>
                                        </select>
                                    </label>
                                </div>
                            </div>

                            <div class="cost-estimate-panel">
                                <div class="cost-item">
                                    <span class="cost-label">推定コスト:</span>
                                    <span class="cost-value" id="image-cost-estimate">$2.00</span>
                                </div>
                                <div class="cost-item">
                                    <span class="cost-label">記事数:</span>
                                    <span class="cost-value" id="image-article-count">10</span>
                                </div>
                                <div class="cost-item">
                                    <span class="cost-label">総画像数:</span>
                                    <span class="cost-value" id="image-total-count">40</span>
                                </div>
                            </div>

                            <div class="image-gen-actions">
                                <button class="btn btn-primary btn-large" id="generate-images-btn">
                                    <span class="btn-icon">🎨</span>
                                    画像を生成
                                </button>
                                <button class="btn btn-secondary" id="skip-images-btn" style="display: none;">
                                    画像生成をスキップ
                                </button>
                            </div>

                            <!-- 生成進捗 -->
                            <div class="image-generation-progress" id="image-generation-progress" style="display: none;">
                                <div class="progress-header">
                                    <h4>画像生成中...</h4>
                                    <span id="image-progress-status">準備中</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="image-progress-fill"></div>
                                </div>
                                <div class="progress-details">
                                    <p id="image-progress-text">画像生成中... (0/10)</p>
                                    <p id="image-current-article"></p>
                                    <p class="progress-cost">コスト: <span id="image-current-cost">$0.00</span></p>
                                </div>
                            </div>

                            <!-- 画像プレビュー -->
                            <div class="generated-images-preview" id="generated-images-preview" style="display: none;">
                                <div class="preview-header">
                                    <h4>生成された画像</h4>
                                    <button class="btn btn-small btn-secondary" id="toggle-images-preview">
                                        <span class="btn-icon">👁️</span>
                                        すべて表示
                                    </button>
                                </div>
                                <div class="images-grid" id="images-grid">
                                    <!-- 画像カードがここに動的に追加される -->
                                </div>
                            </div>
                        </div>

                        <!-- 最終アクション -->
                        <div class="final-actions-card">
                            <div class="actions-header">
                                <h3>
                                    <span class="actions-icon">🚀</span>
                                    公開オプション
                                </h3>
                                <div class="actions-info">
                                    <span>すべての記事が準備完了です</span>
                                </div>
                            </div>

                            <div class="final-actions">
                                <div class="action-group">
                                    <button class="btn btn-secondary btn-large" id="download-all-btn">
                                        <span class="btn-icon">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                                <polyline points="7,10 12,15 17,10"></polyline>
                                                <line x1="12" y1="15" x2="12" y2="3"></line>
                                            </svg>
                                        </span>
                                        全記事をダウンロード
                                    </button>
                                    <div class="action-description">
                                        <p>HTML、Markdown、またはWordファイルとしてダウンロード</p>
                                    </div>
                                </div>

                                <div class="action-group">
                                    <button class="btn btn-primary btn-large" id="publish-cms-btn" onclick="openWordPressModal()">
                                        <span class="btn-icon">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                                            </svg>
                                        </span>
                                        WordPressへ下書き保存
                                    </button>
                                    <div class="action-description">
                                        <p>生成した記事をWordPressの下書きとして保存</p>
                                    </div>
                                </div>
                            </div>

                            <div class="final-notes">
                                <div class="note-item">
                                    <span class="note-icon">💡</span>
                                    <span>記事は公開後も編集・更新が可能です</span>
                                </div>
                                <div class="note-item">
                                    <span class="note-icon">🔍</span>
                                    <span>SEO効果の測定は公開から2-4週間後に確認してください</span>
                                </div>
                                <div class="note-item">
                                    <span class="note-icon">📈</span>
                                    <span>内部リンクの効果を最大化するため、定期的な更新をお勧めします</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ナビゲーションボタン -->
            <div class="navigation-buttons">
                <button class="btn btn-secondary" id="prev-btn">
                    ← 戻る
                </button>
                <button class="btn btn-primary" id="next-btn">
                    次へ →
                </button>
            </div>
        </main>
    </div>
    </div><!-- /main-app -->

    <!-- ローディングオーバーレイ -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">処理中...</div>
    </div>

    <!-- WordPress下書き保存モーダル -->
    <div id="wordpress-modal" class="wordpress-modal hidden">
        <div class="wordpress-modal-content">
            <div class="wordpress-modal-header">
                <h3><span class="wordpress-icon">📝</span> WordPressへ下書き保存</h3>
                <button class="wordpress-close-btn" onclick="closeWordPressModal()">×</button>
            </div>

            <!-- 接続ステータス -->
            <div id="wp-connection-status" class="wordpress-connection-status disconnected">
                <span>⚠️</span>
                <span>WordPress未接続</span>
            </div>

            <!-- WordPress設定フォーム -->
            <form id="wordpress-config-form" onsubmit="saveWordPressConfig(event)">
                <div class="wordpress-form-group">
                    <label for="wp-site-url">サイトURL</label>
                    <input
                        type="url"
                        id="wp-site-url"
                        placeholder="https://example.com"
                        required
                    >
                    <div class="wordpress-form-help">
                        WordPressサイトのURL（例: https://example.com）
                    </div>
                </div>

                <div class="wordpress-form-group">
                    <label for="wp-username">ユーザー名</label>
                    <input
                        type="text"
                        id="wp-username"
                        placeholder="admin"
                        required
                    >
                </div>

                <div class="wordpress-form-group">
                    <label for="wp-app-password">アプリケーションパスワード</label>
                    <input
                        type="password"
                        id="wp-app-password"
                        placeholder="xxxx xxxx xxxx xxxx xxxx xxxx"
                        required
                    >
                    <div class="wordpress-form-help">
                        <a href="https://wordpress.org/support/article/application-passwords/" target="_blank">
                            アプリケーションパスワードの作成方法 →
                        </a>
                    </div>
                </div>

                <div class="wordpress-btn-group">
                    <button type="button" class="wordpress-btn wordpress-btn-secondary" onclick="testWordPressConnection()">
                        接続テスト
                    </button>
                    <button type="submit" class="wordpress-btn wordpress-btn-primary">
                        設定を保存
                    </button>
                </div>
            </form>

            <!-- 投稿オプション -->
            <div class="wordpress-publish-options" id="wordpress-publish-options" style="display: none;">
                <h4>投稿オプション</h4>

                <div class="wordpress-option-group">
                    <label for="wp-post-status">ステータス</label>
                    <select id="wp-post-status" class="wordpress-form-group">
                        <option value="draft" selected>下書き</option>
                        <option value="publish">公開</option>
                        <option value="pending">レビュー待ち</option>
                    </select>
                </div>

                <div class="wordpress-option-group">
                    <label for="wp-category">カテゴリー（オプション）</label>
                    <select id="wp-category">
                        <option value="">選択しない</option>
                    </select>
                </div>

                <div class="wordpress-option-group wordpress-checkbox-group">
                    <input type="checkbox" id="wp-upload-images" checked>
                    <label for="wp-upload-images">画像もWordPressにアップロード</label>
                </div>

                <div class="wordpress-btn-group">
                    <button type="button" class="wordpress-btn wordpress-btn-primary" onclick="publishToWordPress()">
                        下書き保存開始
                    </button>
                </div>
            </div>

            <!-- 進捗表示 -->
            <div class="wordpress-progress" id="wordpress-progress">
                <div class="wordpress-progress-bar">
                    <div class="wordpress-progress-fill" id="wordpress-progress-fill"></div>
                </div>
                <div class="wordpress-progress-text" id="wordpress-progress-text">
                    保存中... 0/0
                </div>
            </div>

            <!-- 結果表示 -->
            <div class="wordpress-results" id="wordpress-results"></div>

            <!-- サマリー -->
            <div class="wordpress-summary" id="wordpress-summary" style="display: none;">
                <div class="wordpress-summary-item">
                    <div class="wordpress-summary-value" id="wp-summary-total">0</div>
                    <div class="wordpress-summary-label">合計</div>
                </div>
                <div class="wordpress-summary-item">
                    <div class="wordpress-summary-value" id="wp-summary-success" style="color: #28a745;">0</div>
                    <div class="wordpress-summary-label">成功</div>
                </div>
                <div class="wordpress-summary-item">
                    <div class="wordpress-summary-value" id="wp-summary-failure" style="color: #dc3545;">0</div>
                    <div class="wordpress-summary-label">失敗</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- 共通ユーティリティ -->
    <script src="./src/utils/Constants.js"></script>
    <script src="./src/utils/ErrorHandler.js"></script>

    <!-- サービス層 -->
    <script src="./src/services/StorageService.js"></script>
    <script src="./src/services/NotificationService.js"></script>

    <!-- コア層（基本クラス） -->
    <script src="./src/core/DataStore.js"></script>
    <script src="./src/core/GenerationState.js"></script>
    <script src="./src/core/PerformanceMonitor.js"></script>
    <script src="./src/core/ResourceManager.js"></script>

    <!-- UI層 -->
    <script src="./src/ui/TemplateEngine.js"></script>
    <script src="./src/ui/UIRenderer.js"></script>

    <!-- コア層（依存関係のあるクラス） -->
    <script src="./src/core/ContentGenerator.js"></script>
    <script src="./src/core/WizardController.js"></script>
    <script src="./src/core/HubPilotApp.js"></script>
    <script src="./src/core/HubPilotApp-simple.js"></script>
    <script src="./src/core/DeveloperTestSuite.js"></script>
    <script src="./src/core/IntegrationTestSuite.js"></script>

    <!-- Supabase設定 -->
    <script src="./supabase-config.js"></script>

    <!-- Supabase統合レイヤー -->
    <script src="./supabase-integration.js"></script>

    <!-- 認証マネージャー -->
    <script src="./auth-manager.js"></script>

    <!-- WordPress統合 -->
    <script src="./wordpress-integration.js"></script>

    <!-- 認証UI JavaScript -->
    <script>
        // タブ切替
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tabs button').forEach(btn => {
                btn.classList.remove('active')
            })
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active')

            document.querySelectorAll('.auth-form').forEach(form => {
                form.classList.remove('active')
            })
            document.getElementById(`${tab}-form`).classList.add('active')

            hideAuthMessage()
        }

        // ログイン処理
        async function handleSignIn(event) {
            event.preventDefault()
            const email = document.getElementById('signin-email').value
            const password = document.getElementById('signin-password').value
            const button = document.getElementById('signin-button')

            button.disabled = true
            button.classList.add('loading')

            try {
                await window.authManager.signIn(email, password)
                showAuthMessage('ログインしました', 'success')
            } catch (error) {
                console.error('ログインエラー:', error)
                showAuthMessage(
                    error.message || 'ログインに失敗しました。メールアドレスとパスワードを確認してください。',
                    'error'
                )
            } finally {
                button.disabled = false
                button.classList.remove('loading')
            }
        }

        // 新規登録処理
        async function handleSignUp(event) {
            event.preventDefault()
            const name = document.getElementById('signup-name').value
            const email = document.getElementById('signup-email').value
            const password = document.getElementById('signup-password').value
            const confirmPassword = document.getElementById('signup-password-confirm').value
            const button = document.getElementById('signup-button')

            if (password !== confirmPassword) {
                document.getElementById('password-error').textContent = 'パスワードが一致しません'
                document.getElementById('password-error').classList.add('visible')
                return
            } else {
                document.getElementById('password-error').classList.remove('visible')
            }

            button.disabled = true
            button.classList.add('loading')

            try {
                const result = await window.authManager.signUp(email, password, name)

                if (result.requiresEmailConfirmation) {
                    showAuthMessage('確認メールを送信しました。メールをご確認ください。', 'info')
                    setTimeout(() => switchAuthTab('signin'), 3000)
                } else {
                    showAuthMessage('アカウントを作成しました', 'success')
                }
            } catch (error) {
                console.error('登録エラー:', error)
                showAuthMessage(
                    error.message || '登録に失敗しました。別のメールアドレスをお試しください。',
                    'error'
                )
            } finally {
                button.disabled = false
                button.classList.remove('loading')
            }
        }

        // ソーシャルログイン
        async function handleSocialLogin(provider) {
            try {
                await window.authManager.signInWithProvider(provider)
            } catch (error) {
                console.error('ソーシャルログインエラー:', error)
                showAuthMessage(`${provider}でのログインに失敗しました`, 'error')
            }
        }

        // ゲストログイン
        function handleGuestLogin() {
            window.authManager.continueAsGuest()
        }

        // パスワードリセット
        async function showPasswordReset() {
            const email = document.getElementById('signin-email').value

            if (!email) {
                showAuthMessage('メールアドレスを入力してください', 'error')
                return
            }

            const confirmed = confirm(`${email} にパスワードリセットメールを送信しますか？`)

            if (!confirmed) return

            try {
                await window.authManager.sendPasswordResetEmail(email)
                showAuthMessage('パスワードリセットメールを送信しました', 'success')
            } catch (error) {
                console.error('パスワードリセットエラー:', error)
                showAuthMessage('メール送信に失敗しました', 'error')
            }
        }

        // メッセージ表示
        function showAuthMessage(message, type) {
            const messageEl = document.getElementById('auth-message')
            messageEl.textContent = message
            messageEl.className = `auth-message visible ${type}`
        }

        // メッセージ非表示
        function hideAuthMessage() {
            const messageEl = document.getElementById('auth-message')
            messageEl.classList.remove('visible')
        }
    </script>

    <!-- アプリケーション初期化 -->
    <script>
        // 新しいリファクタリングされたアプリケーションを初期化
        let app;

        // エラーハンドリングを追加
        window.addEventListener('error', (event) => {
            console.error('🚨 グローバルエラー:', event.error);
            console.error('📍 ファイル:', event.filename);
            console.error('📍 行:', event.lineno);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('🚨 未処理のPromise拒否:', event.reason);
        });

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('🚀 HubPilot Free を初期化中...');

                // 重複初期化を防ぐ
                if (window.appInitialized) {
                    console.log('⚠️ アプリケーションは既に初期化済みです');
                    return;
                }
                window.appInitialized = true;

                // Supabase統合を初期化
                if (window.supabaseIntegration && !window.supabaseIntegration.isInitialized) {
                    console.log('🔧 Supabase統合を初期化中...');
                    await window.supabaseIntegration.initialize();
                }

                // 認証モードを確認（簡素化）
                let authMode = 'guest'; // デフォルトはゲストモード
                if (window.authManager && typeof window.authManager.getAuthMode === 'function') {
                    authMode = window.authManager.getAuthMode();
                }
                console.log('🔍 認証モード:', authMode);

                if (authMode === 'unauthenticated') {
                    // 認証が必要な場合は認証画面を表示
                    console.log('📝 認証画面を表示');
                    if (window.authManager && typeof window.authManager.showAuthUI === 'function') {
                        window.authManager.showAuthUI();
                    }
                } else {
                    // メインアプリケーションを初期化
                    console.log('🎯 メインアプリケーションを初期化');

                    let app = null;
                    if (typeof HubPilotApp !== 'undefined') {
                        console.log('📱 HubPilotAppクラスを使用');
                        app = new HubPilotApp();
                        window.app = app;
                        console.log('✅ HubPilotApp初期化成功');
                    } else if (typeof HubPilotAppSimple !== 'undefined') {
                        console.log('📱 HubPilotAppSimpleクラスを使用（フォールバック）');
                        app = new HubPilotAppSimple();
                        await app.init();
                        window.app = app;
                        console.log('✅ HubPilotAppSimple初期化成功');
                    } else {
                        throw new Error('HubPilotAppクラスが読み込まれていません');
                    }

                    // 画像生成機能を初期化
                    if (typeof ImageGenerationManager !== 'undefined' && app) {
                        try {
                            window.imageGenerationManager = new ImageGenerationManager(app);
                            console.log('✅ 画像生成機能が初期化されました');
                        } catch (error) {
                            console.warn('⚠️ 画像生成機能の初期化に失敗:', error);
                        }
                    }

                    console.log('✅ HubPilot Free が正常に初期化されました');
                }

            } catch (error) {
                console.error('❌ アプリケーションの初期化に失敗しました:', error);

                // エラー情報をユーザーに表示
                const errorMessage = document.createElement('div');
                errorMessage.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #ff4444;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    z-index: 10000;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                `;
                errorMessage.textContent = 'アプリケーションの初期化に失敗しました。ページを再読み込みしてください。';
                document.body.appendChild(errorMessage);

                // 5秒後にエラーメッセージを削除
                setTimeout(() => {
                    if (errorMessage.parentNode) {
                        errorMessage.parentNode.removeChild(errorMessage);
                    }
                }, 5000);
            }
        });

                // 最後の手段: 基本的なボタン機能だけでも動作させる
                console.log('🔄 最後の手段: 基本的なボタン機能を設定中...');
                setTimeout(() => {
                    try {
                        // 認証画面を非表示にしてメインアプリを表示
                        const authOverlay = document.getElementById('auth-overlay');
                        const mainApp = document.getElementById('main-app');

                        if (authOverlay) authOverlay.style.display = 'none';
                        if (mainApp) mainApp.classList.remove('hidden');

                        // Simple Appを初期化
                        if (typeof SimpleApp !== 'undefined' && !window.simpleApp) {
                            console.log('🔄 Initializing SimpleApp as last resort...');
                            try {
                                window.simpleApp = new SimpleApp();
                                window.app = window.simpleApp;
                                console.log('✅ SimpleApp initialized as last resort');
                            } catch (simpleAppError) {
                                console.error('❌ SimpleApp initialization failed:', simpleAppError);
                            }
                        }

                        // ボタン修復を実行
                        if (typeof window.fixCreateNewConfigButton === 'function') {
                            window.fixCreateNewConfigButton();
                            console.log('✅ 基本的なボタン機能を設定しました');
                        }

                        // 緊急ボタン修復
                        const emergencyFixButtons = () => {
                            console.log('🚨 緊急ボタン修復を実行中...');

                            // 「この構成で進める」ボタンの緊急修復
                            const proceedBtn = document.getElementById('proceed-to-headings-btn');
                            if (proceedBtn && !proceedBtn.hasAttribute('data-emergency-fixed')) {
                                proceedBtn.setAttribute('data-emergency-fixed', 'true');
                                proceedBtn.addEventListener('click', (e) => {
                                    e.preventDefault();
                                    console.log('🚨 緊急修復: 「この構成で進める」ボタンがクリックされました');

                                    // URLパラメータでステップ3に移動
                                    const url = new URL(window.location);
                                    url.searchParams.set('step', '3');
                                    window.location.href = url.toString();
                                });
                                console.log('✅ 緊急修復: 「この構成で進める」ボタンを修復');
                            }

                            // 「記事執筆を開始」ボタンの緊急修復
                            const startWritingBtn = document.getElementById('start-writing-btn');
                            if (startWritingBtn && !startWritingBtn.hasAttribute('data-emergency-fixed')) {
                                startWritingBtn.setAttribute('data-emergency-fixed', 'true');
                                startWritingBtn.addEventListener('click', async (e) => {
                                    e.preventDefault();
                                    console.log('🚨 緊急修復: 「記事執筆を開始」ボタンがクリックされました');

                                    // ボタンを無効化
                                    startWritingBtn.disabled = true;
                                    startWritingBtn.textContent = '生成中...';

                                    try {
                                        // 実際のアプリがある場合は記事生成を実行
                                        if (window.app && window.app.contentGenerator) {
                                            const pages = window.app.wizardController?.data?.clusterPages || [];
                                            if (pages.length > 0) {
                                                console.log('📝 記事生成を開始します...', pages);

                                                // 進捗表示を更新
                                                const progressFill = document.getElementById('progress-fill');
                                                const progressText = document.getElementById('progress-text');
                                                const progressStatus = document.getElementById('progress-status');

                                                if (progressStatus) progressStatus.textContent = '記事生成中...';

                                                // 各記事を順次生成
                                                const articles = [];
                                                for (let i = 0; i < pages.length; i++) {
                                                    const page = pages[i];
                                                    const progress = ((i + 1) / pages.length) * 100;

                                                    // 進捗更新
                                                    if (progressFill) progressFill.style.width = `${progress}%`;
                                                    if (progressText) progressText.textContent = `記事 ${i + 1}/${pages.length} を作成中: ${page.title}`;

                                                    // 記事生成（モック）
                                                    await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));

                                                    const article = {
                                                        id: page.id,
                                                        title: page.title,
                                                        content: `# ${page.title}\n\n${page.title}について詳しく解説します。\n\nこの記事では、${page.title}の重要なポイントを説明し、実践的な手法を紹介します。`,
                                                        wordCount: 1500 + Math.floor(Math.random() * 1000),
                                                        qualityStatus: '生成完了',
                                                        generatedAt: new Date().toISOString()
                                                    };

                                                    articles.push(article);
                                                    console.log(`✅ 記事生成完了: ${article.title}`);
                                                }

                                                // データを保存
                                                window.app.wizardController.saveData({ articles });

                                                // 完了表示
                                                if (progressStatus) progressStatus.textContent = '生成完了！';
                                                if (progressText) progressText.textContent = `全${articles.length}記事の生成が完了しました`;

                                                console.log('🎉 全記事の生成が完了しました');

                                                // 2秒後に次のステップに移動
                                                setTimeout(() => {
                                                    window.app.wizardController.nextStep();
                                                }, 2000);
                                            } else {
                                                console.warn('⚠️ 生成対象のページがありません');
                                                alert('生成対象のページがありません。構成案を先に作成してください。');
                                            }
                                        } else {
                                            console.log('⚠️ アプリインスタンスが見つかりません。フォールバック処理を実行します。');

                                            // フォールバック: 3秒後にステップ5に移動
                                            await new Promise(resolve => setTimeout(resolve, 3000));
                                            const url = new URL(window.location);
                                            url.searchParams.set('step', '5');
                                            window.location.href = url.toString();
                                        }
                                    } catch (error) {
                                        console.error('記事生成エラー:', error);
                                        alert('記事生成中にエラーが発生しました: ' + error.message);

                                        // エラー時もステップ5に移動
                                        const url = new URL(window.location);
                                        url.searchParams.set('step', '5');
                                        window.location.href = url.toString();
                                    } finally {
                                        // ボタンを元に戻す
                                        startWritingBtn.disabled = false;
                                        startWritingBtn.textContent = '記事執筆を開始（時間がかかります）';
                                    }
                                });
                                console.log('✅ 緊急修復: 「記事執筆を開始」ボタンを修復');
                            }

                            // 構成案生成ボタンの緊急修復
                            const generateBtn = document.getElementById('generate-structure-btn');
                            if (generateBtn && !generateBtn.hasAttribute('data-emergency-fixed')) {
                                generateBtn.setAttribute('data-emergency-fixed', 'true');
                                generateBtn.addEventListener('click', async (e) => {
                                    e.preventDefault();
                                    console.log('🚨 緊急修復: 「構成案を作成」ボタンがクリックされました');

                                    const themeInput = document.getElementById('theme-input');
                                    const theme = themeInput ? themeInput.value.trim() : '';

                                    if (!theme) {
                                        alert('テーマを入力してください');
                                        return;
                                    }

                                    // ボタンを無効化
                                    generateBtn.disabled = true;
                                    generateBtn.textContent = '生成中...';

                                    try {
                                        // 実際のアプリがある場合は構造生成を実行
                                        if (window.app && window.app.wizardController) {
                                            await window.app.wizardController.generateStructure();
                                        } else {
                                            // フォールバック: 2秒後にステップ2に移動
                                            await new Promise(resolve => setTimeout(resolve, 2000));
                                            const url = new URL(window.location);
                                            url.searchParams.set('step', '2');
                                            window.location.href = url.toString();
                                        }
                                    } catch (error) {
                                        console.error('構造生成エラー:', error);
                                        // エラー時もステップ2に移動
                                        const url = new URL(window.location);
                                        url.searchParams.set('step', '2');
                                        window.location.href = url.toString();
                                    }
                                });
                                console.log('✅ 緊急修復: 「構成案を作成」ボタンを修復');
                            }
                        };

                        // 緊急修復を実行
                        emergencyFixButtons();

                        // 定期的に緊急修復を実行（動的に生成されるボタン対応）
                        setInterval(emergencyFixButtons, 5000);

                        // URLパラメータからステップを読み込んで表示
                        const urlParams = new URLSearchParams(window.location.search);
                        const stepParam = urlParams.get('step');
                        if (stepParam) {
                            const step = parseInt(stepParam);
                            if (step >= 1 && step <= 6) {
                                console.log(`📍 URLパラメータからステップ${step}を読み込み`);

                                // ステップインジケーターを更新
                                document.querySelectorAll('.step-item').forEach((item, index) => {
                                    item.classList.remove('active', 'completed');
                                    const stepNumber = index + 1;
                                    if (stepNumber === step) {
                                        item.classList.add('active');
                                    } else if (stepNumber < step) {
                                        item.classList.add('completed');
                                    }
                                });

                                // ステップコンテンツを表示
                                document.querySelectorAll('.step-content').forEach(el => {
                                    el.classList.remove('active');
                                });
                                const stepEl = document.getElementById(`step-${step}`);
                                if (stepEl) {
                                    stepEl.classList.add('active');
                                }
                            }
                        }

                    } catch (fallbackError) {
                        console.error('❌ 最後の手段も失敗:', fallbackError);
                    }
                }, 2000);
            }
        });

        // デバッグ用のグローバル関数を追加
        window.debugButtons = () => {
            console.log('🔍 ボタンの状態をチェック中...');

            const buttons = [
                'proceed-to-headings-btn',
                'start-writing-btn',
                'generate-structure-btn',
                'next-btn',
                'prev-btn'
            ];

            buttons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    console.log(`✅ ${id}: 存在する`, {
                        disabled: btn.disabled,
                        visible: btn.style.display !== 'none',
                        hasEventListeners: btn.hasAttribute('data-fixed') || btn.hasAttribute('data-emergency-fixed')
                    });
                } else {
                    console.log(`❌ ${id}: 見つからない`);
                }
            });
        };

        // アプリケーション状態をデバッグする関数
        window.debugAppState = () => {
            console.log('🔍 アプリケーション状態をチェック中...');

            // 現在のステップを確認
            const activeStep = document.querySelector('.step-content.active');
            if (activeStep) {
                console.log('📍 現在のステップ:', activeStep.id);
            }

            // アプリインスタンスの確認
            if (window.app) {
                console.log('✅ window.app が存在します');
                console.log('📊 アプリデータ:', window.app.getData ? window.app.getData() : 'getData メソッドなし');

                if (window.app.wizardController) {
                    console.log('📍 現在のステップ番号:', window.app.wizardController.currentStep);
                    console.log('📊 ウィザードデータ:', window.app.wizardController.data);
                }
            } else {
                console.log('❌ window.app が存在しません');
            }

            // URLパラメータの確認
            const urlParams = new URLSearchParams(window.location.search);
            const stepParam = urlParams.get('step');
            console.log('🔗 URLステップパラメータ:', stepParam);

            // ローカルストレージの確認
            try {
                const savedData = localStorage.getItem('hubpilot-data');
                if (savedData) {
                    console.log('💾 ローカルストレージデータ:', JSON.parse(savedData));
                } else {
                    console.log('💾 ローカルストレージにデータなし');
                }
            } catch (error) {
                console.log('❌ ローカルストレージ読み込みエラー:', error);
            }
        };

        // 記事生成を強制実行する関数
        window.forceStartGeneration = () => {
            console.log('🚀 記事生成を強制実行中...');

            // モック記事データを生成
            const mockArticles = [
                {
                    id: 'cluster-1',
                    title: 'テスト記事1',
                    content: 'これはテスト記事の内容です。',
                    wordCount: 1500,
                    qualityStatus: 'テスト生成完了',
                    generatedAt: new Date().toISOString()
                },
                {
                    id: 'cluster-2',
                    title: 'テスト記事2',
                    content: 'これは2番目のテスト記事の内容です。',
                    wordCount: 1800,
                    qualityStatus: 'テスト生成完了',
                    generatedAt: new Date().toISOString()
                }
            ];

            // アプリにデータを保存
            if (window.app && window.app.wizardController) {
                window.app.wizardController.saveData({ articles: mockArticles });
                console.log('✅ モック記事データを保存しました');

                // 次のステップに移動
                window.app.wizardController.nextStep();
                console.log('✅ 次のステップに移動しました');
            } else {
                console.log('❌ アプリインスタンスが見つかりません');
            }
        };

        // 手動でボタンを修復する関数
        window.manualFixButtons = () => {
            console.log('🔧 手動でボタンを修復中...');

            // 「この構成で進める」ボタン
            const proceedBtn = document.getElementById('proceed-to-headings-btn');
            if (proceedBtn) {
                proceedBtn.onclick = (e) => {
                    e.preventDefault();
                    console.log('🔘 手動修復: 「この構成で進める」ボタンがクリックされました');
                    const url = new URL(window.location);
                    url.searchParams.set('step', '3');
                    window.location.href = url.toString();
                };
                console.log('✅ 「この構成で進める」ボタンを手動修復');
            }

            // 「記事執筆を開始」ボタン
            const startWritingBtn = document.getElementById('start-writing-btn');
            if (startWritingBtn) {
                startWritingBtn.onclick = async (e) => {
                    e.preventDefault();
                    console.log('🔘 手動修復: 「記事執筆を開始」ボタンがクリックされました');

                    // ボタンを無効化
                    startWritingBtn.disabled = true;
                    startWritingBtn.textContent = '生成中...';

                    try {
                        // 実際のアプリがある場合は記事生成を実行
                        if (window.app && window.app.contentGenerator) {
                            const pages = window.app.wizardController?.data?.clusterPages || [];
                            if (pages.length > 0) {
                                console.log('📝 記事生成を開始します...', pages);

                                // 進捗表示を更新
                                const progressFill = document.getElementById('progress-fill');
                                const progressText = document.getElementById('progress-text');
                                const progressStatus = document.getElementById('progress-status');

                                if (progressStatus) progressStatus.textContent = '記事生成中...';

                                // 各記事を順次生成
                                const articles = [];
                                for (let i = 0; i < pages.length; i++) {
                                    const page = pages[i];
                                    const progress = ((i + 1) / pages.length) * 100;

                                    // 進捗更新
                                    if (progressFill) progressFill.style.width = `${progress}%`;
                                    if (progressText) progressText.textContent = `記事 ${i + 1}/${pages.length} を作成中: ${page.title}`;

                                    // 記事生成（モック）
                                    await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));

                                    const article = {
                                        id: page.id,
                                        title: page.title,
                                        content: `# ${page.title}\n\n${page.title}について詳しく解説します。\n\nこの記事では、${page.title}の重要なポイントを説明し、実践的な手法を紹介します。`,
                                        wordCount: 1500 + Math.floor(Math.random() * 1000),
                                        qualityStatus: '生成完了',
                                        generatedAt: new Date().toISOString()
                                    };

                                    articles.push(article);
                                    console.log(`✅ 記事生成完了: ${article.title}`);
                                }

                                // データを保存
                                window.app.wizardController.saveData({ articles });

                                // 完了表示
                                if (progressStatus) progressStatus.textContent = '生成完了！';
                                if (progressText) progressText.textContent = `全${articles.length}記事の生成が完了しました`;

                                console.log('🎉 全記事の生成が完了しました');

                                // 2秒後に次のステップに移動
                                setTimeout(() => {
                                    window.app.wizardController.nextStep();
                                }, 2000);
                            } else {
                                console.warn('⚠️ 生成対象のページがありません');
                                alert('生成対象のページがありません。構成案を先に作成してください。');
                            }
                        } else {
                            console.log('⚠️ アプリインスタンスが見つかりません。フォールバック処理を実行します。');

                            // フォールバック: 3秒後にステップ5に移動
                            await new Promise(resolve => setTimeout(resolve, 3000));
                            const url = new URL(window.location);
                            url.searchParams.set('step', '5');
                            window.location.href = url.toString();
                        }
                    } catch (error) {
                        console.error('記事生成エラー:', error);
                        alert('記事生成中にエラーが発生しました: ' + error.message);

                        // エラー時もステップ5に移動
                        const url = new URL(window.location);
                        url.searchParams.set('step', '5');
                        window.location.href = url.toString();
                    } finally {
                        // ボタンを元に戻す
                        startWritingBtn.disabled = false;
                        startWritingBtn.textContent = '記事執筆を開始（時間がかかります）';
                    }
                };
                console.log('✅ 「記事執筆を開始」ボタンを手動修復');
            }

            // 構成案生成ボタン
            const generateBtn = document.getElementById('generate-structure-btn');
            if (generateBtn) {
                generateBtn.onclick = async (e) => {
                    e.preventDefault();
                    console.log('🔘 手動修復: 「構成案を作成」ボタンがクリックされました');
                    const themeInput = document.getElementById('theme-input');
                    const theme = themeInput ? themeInput.value.trim() : '';

                    if (!theme) {
                        alert('テーマを入力してください');
                        return;
                    }

                    // ボタンを無効化
                    generateBtn.disabled = true;
                    generateBtn.textContent = '生成中...';

                    try {
                        // 実際のアプリがある場合は構造生成を実行
                        if (window.app && window.app.wizardController) {
                            await window.app.wizardController.generateStructure();
                        } else {
                            // フォールバック: 2秒後にステップ2に移動
                            await new Promise(resolve => setTimeout(resolve, 2000));
                            const url = new URL(window.location);
                            url.searchParams.set('step', '2');
                            window.location.href = url.toString();
                        }
                    } catch (error) {
                        console.error('構造生成エラー:', error);
                        // エラー時もステップ2に移動
                        const url = new URL(window.location);
                        url.searchParams.set('step', '2');
                        window.location.href = url.toString();
                    }
                };
                console.log('✅ 「構成案を作成」ボタンを手動修復');
            }

            console.log('✅ 手動ボタン修復完了');
        };
    </script>

    <!-- 画像生成機能 -->
    <script src="./image-generation.js"></script>

    <!-- パフォーマンステスト -->
    <script src="./tests/performance-optimization.test.js"></script>
    <script src="./tests/resource-management.test.js"></script>
    <script src="./tests/developer-test-suite.test.js"></script>
    <script src="./tests/integration-test-execution.test.js"></script>
    <script src="./tests/phase9-integration-test.js"></script>

    <!-- メインアプリケーション初期化 -->
    <script>
        // 認証なしでメインアプリを直接初期化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 認証なしモードでアプリケーションを初期化中...');

            // 認証オーバーレイを確実に非表示
            const authOverlay = document.getElementById('auth-overlay');
            if (authOverlay) {
                authOverlay.style.display = 'none';
                authOverlay.classList.add('hidden');
            }

            // メインアプリを確実に表示
            const mainApp = document.getElementById('main-app');
            if (mainApp) {
                mainApp.classList.remove('hidden');
                mainApp.style.display = 'block';
            }

            // メインアプリケーションを初期化
            setTimeout(() => {
                try {
                    if (!window.app && typeof HubPilotApp !== 'undefined') {
                        window.app = new HubPilotApp();
                        console.log('✅ メインアプリケーションを初期化しました');
                    }
                } catch (error) {
                    console.error('❌ メインアプリケーション初期化エラー:', error);
                }
            }, 100);
        });

        // 開発者向けコンソールコマンドを定義
        setTimeout(() => {
            // DeveloperTestSuiteコマンド
            if (window.DeveloperTestSuite) {
                const developerTestSuite = new window.DeveloperTestSuite();

                // 依存関係を設定
                if (window.app) {
                    developerTestSuite.setDependencies(
                        window.app.contentGenerator,
                        window.app.supabaseIntegration,
                        window.app.progressManager,
                        window.app.errorHandler
                    );
                }

                // グローバルコマンドを定義
                window.runAllDeveloperTests = () => developerTestSuite.runAllTests();
                window.runArticleGenerationTest = () => developerTestSuite.runArticleGenerationTest();
                window.runApiConnectionTest = () => developerTestSuite.runApiConnectionTest();
                window.runMockGenerationTest = () => developerTestSuite.runMockGenerationTest();
                window.runProgressManagementTest = () => developerTestSuite.runProgressManagementTest();
                window.runErrorHandlingTest = () => developerTestSuite.runErrorHandlingTest();
            }

            // IntegrationTestSuiteコマンド
            if (window.IntegrationTestSuite) {
                const integrationTestSuite = new window.IntegrationTestSuite();

                // 依存関係を設定
                if (window.app) {
                    integrationTestSuite.setDependencies(
                        window.app,
                        window.app.contentGenerator,
                        window.app.supabaseIntegration,
                        window.app.progressManager,
                        window.app.errorHandler
                    );
                }

                // グローバルコマンドを定義
                window.runAllIntegrationTests = () => integrationTestSuite.runAllIntegrationTests();
                window.runEndToEndTest = () => integrationTestSuite.runEndToEndTest();
                window.runErrorScenarioTest = () => integrationTestSuite.runErrorScenarioTest();
                window.runPerformanceTest = () => integrationTestSuite.runPerformanceTest();
                window.runComponentIntegrationTest = () => integrationTestSuite.runComponentIntegrationTest();
            }

            // ヘルプコマンド
            window.showTestCommands = () => {
                console.log('🧪 ========== 利用可能なテストコマンド ==========');
                console.log('');
                console.log('📝 開発者テスト:');
                console.log('  runAllDeveloperTests()        - 全開発者テストを実行');
                console.log('  runArticleGenerationTest()    - 記事生成テストを実行');
                console.log('  runApiConnectionTest()        - API接続テストを実行');
                console.log('  runMockGenerationTest()       - モック生成テストを実行');
                console.log('  runProgressManagementTest()   - 進捗管理テストを実行');
                console.log('  runErrorHandlingTest()        - エラーハンドリングテストを実行');
                console.log('');
                console.log('🔗 統合テスト:');
                console.log('  runAllIntegrationTests()      - 全統合テストを実行');
                console.log('  runEndToEndTest()             - エンドツーエンドテストを実行');
                console.log('  runErrorScenarioTest()        - エラーシナリオテストを実行');
                console.log('  runPerformanceTest()          - パフォーマンステストを実行');
                console.log('  runComponentIntegrationTest() - コンポーネント統合テストを実行');
                console.log('');
                console.log('📊 パフォーマンス監視:');
                console.log('  performanceMonitor.showPerformanceReport() - パフォーマンスレポート表示');
                console.log('  resourceManager.logResourceStats()         - リソース統計表示');
                console.log('');
                console.log('🎯 その他:');
                console.log('  showTestCommands()            - このヘルプを表示');
                console.log('===============================================');
            };

            console.log('✅ 開発者向けテストコマンドが利用可能になりました');
            console.log('💡 showTestCommands() でコマンド一覧を表示できます');

        }, 2000);
    </script>

    <!-- WordPress統合UI JavaScript -->
    <script>
        // WordPressモーダルを開く
        function openWordPressModal() {
            const modal = document.getElementById('wordpress-modal')
            modal.classList.remove('hidden')

            // 既存の設定を読み込み
            loadWordPressSettings()

            // 接続状態を確認
            if (window.wordpressIntegration.isConfigured()) {
                document.getElementById('wp-connection-status').className = 'wordpress-connection-status connected'
                document.getElementById('wp-connection-status').innerHTML = '<span>✅</span><span>WordPress接続済み</span>'
                document.getElementById('wordpress-publish-options').style.display = 'block'

                // カテゴリーを読み込み
                loadWordPressCategories()
            }
        }

        // WordPressモーダルを閉じる
        function closeWordPressModal() {
            const modal = document.getElementById('wordpress-modal')
            modal.classList.add('hidden')

            // 進捗をリセット
            document.getElementById('wordpress-progress').classList.remove('visible')
            document.getElementById('wordpress-results').innerHTML = ''
            document.getElementById('wordpress-summary').style.display = 'none'
        }

        // WordPress設定を読み込み
        function loadWordPressSettings() {
            const config = window.wordpressIntegration.config

            if (config.siteUrl) {
                document.getElementById('wp-site-url').value = config.siteUrl
            }
            if (config.username) {
                document.getElementById('wp-username').value = config.username
            }
            if (config.applicationPassword) {
                document.getElementById('wp-app-password').value = config.applicationPassword
            }
            if (config.defaultStatus) {
                document.getElementById('wp-post-status').value = config.defaultStatus
            }
        }

        // WordPress接続テスト
        async function testWordPressConnection() {
            const siteUrl = document.getElementById('wp-site-url').value
            const username = document.getElementById('wp-username').value
            const appPassword = document.getElementById('wp-app-password').value

            if (!siteUrl || !username || !appPassword) {
                alert('すべての項目を入力してください')
                return
            }

            const statusEl = document.getElementById('wp-connection-status')
            statusEl.className = 'wordpress-connection-status testing'
            statusEl.innerHTML = '<span>🔄</span><span>接続テスト中...</span>'

            try {
                const result = await window.wordpressIntegration.testConnection(
                    siteUrl,
                    username,
                    appPassword
                )

                if (result.success) {
                    statusEl.className = 'wordpress-connection-status connected'
                    statusEl.innerHTML = `<span>✅</span><span>${result.message}</span>`

                    // 投稿オプションを表示
                    document.getElementById('wordpress-publish-options').style.display = 'block'

                    // カテゴリーを読み込み
                    await loadWordPressCategories()
                } else {
                    statusEl.className = 'wordpress-connection-status disconnected'
                    statusEl.innerHTML = `<span>❌</span><span>${result.message}</span>`
                }

            } catch (error) {
                statusEl.className = 'wordpress-connection-status disconnected'
                statusEl.innerHTML = `<span>❌</span><span>接続失敗: ${error.message}</span>`
            }
        }

        // WordPress設定を保存
        function saveWordPressConfig(event) {
            event.preventDefault()

            const config = {
                siteUrl: document.getElementById('wp-site-url').value,
                username: document.getElementById('wp-username').value,
                applicationPassword: document.getElementById('wp-app-password').value,
                defaultStatus: document.getElementById('wp-post-status').value
            }

            const success = window.wordpressIntegration.saveConfig(config)

            if (success) {
                alert('設定を保存しました')
            } else {
                alert('設定の保存に失敗しました')
            }
        }

        // カテゴリーを読み込み
        async function loadWordPressCategories() {
            try {
                const result = await window.wordpressIntegration.getCategories()

                if (result.success) {
                    const select = document.getElementById('wp-category')
                    select.innerHTML = '<option value="">選択しない</option>'

                    result.categories.forEach(cat => {
                        const option = document.createElement('option')
                        option.value = cat.id
                        option.textContent = `${cat.name} (${cat.count})`
                        select.appendChild(option)
                    })
                }
            } catch (error) {
                console.error('カテゴリー読み込みエラー:', error)
            }
        }

        // WordPressへ下書き保存
        async function publishToWordPress() {
            if (!window.app || !window.app.data || !window.app.data.articles || window.app.data.articles.length === 0) {
                alert('保存する記事がありません。先に記事を生成してください。')
                return
            }

            if (!window.wordpressIntegration.isConfigured()) {
                alert('WordPress設定が完了していません')
                return
            }

            const confirmed = confirm(
                `${window.app.data.articles.length}件の記事をWordPressへ保存しますか？\n\n` +
                `ステータス: ${document.getElementById('wp-post-status').selectedOptions[0].text}`
            )

            if (!confirmed) return

            // UI準備
            document.getElementById('wordpress-progress').classList.add('visible')
            document.getElementById('wordpress-results').innerHTML = ''
            document.getElementById('wordpress-summary').style.display = 'none'

            const options = {
                status: document.getElementById('wp-post-status').value,
                categories: document.getElementById('wp-category').value ? [parseInt(document.getElementById('wp-category').value)] : []
            }

            // 進捗イベントリスナー
            window.addEventListener('wordpress-publish-progress', handleWordPressProgress)

            try {
                const result = await window.wordpressIntegration.publishBatch(
                    window.app.data.articles,
                    options
                )

                // 結果を表示
                displayWordPressResults(result)

            } catch (error) {
                console.error('WordPress投稿エラー:', error)
                alert(`投稿エラー: ${error.message}`)
            } finally {
                window.removeEventListener('wordpress-publish-progress', handleWordPressProgress)
            }
        }

        // 進捗ハンドラー
        function handleWordPressProgress(event) {
            const { current, total, percentage, currentArticle } = event.detail

            document.getElementById('wordpress-progress-fill').style.width = `${percentage}%`
            document.getElementById('wordpress-progress-text').textContent =
                `保存中... ${current}/${total} - ${currentArticle}`
        }

        // 結果を表示
        function displayWordPressResults(result) {
            const resultsEl = document.getElementById('wordpress-results')
            const summaryEl = document.getElementById('wordpress-summary')

            resultsEl.innerHTML = ''

            result.results.forEach(item => {
                const resultItem = document.createElement('div')
                resultItem.className = `wordpress-result-item ${item.success ? 'success' : 'error'}`

                resultItem.innerHTML = `
                    <span class="wordpress-result-icon">${item.success ? '✅' : '❌'}</span>
                    <span class="wordpress-result-title">${item.articleTitle}</span>
                    ${item.success && item.post ? `<a href="${item.post.link}" target="_blank" class="wordpress-result-link">表示 →</a>` : ''}
                `

                resultsEl.appendChild(resultItem)
            })

            // サマリーを表示
            document.getElementById('wp-summary-total').textContent = result.summary.total
            document.getElementById('wp-summary-success').textContent = result.summary.success
            document.getElementById('wp-summary-failure').textContent = result.summary.failure
            summaryEl.style.display = 'grid'

            // 進捗バーを完了状態に
            document.getElementById('wordpress-progress-fill').style.width = '100%'
            document.getElementById('wordpress-progress-text').textContent =
                `完了: ${result.summary.success}/${result.summary.total}件の記事を下書き保存しました`
        }
    </script>
</body>
</html>
