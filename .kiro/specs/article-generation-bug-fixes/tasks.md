# 実装計画: 記事生成バグ修正

## 概要

HubPilot Free SEO記事作成エージェントの記事生成機能における複数のバグと設計上の問題を体系的に修正します。既存のJavaScriptコードベースを維持しながら、安定した記事生成機能を実現します。

## タスク

### Phase 1: ContentGeneratorクラス修正

- [x] 1. ContentGeneratorクラスの記事生成メソッド修正
  - `genees`メソッドの進捗コールバック処理を修正
  - フォールバック機能を強化し、AI API失敗時の安定性を向上
  - 記事データ形式を統一し、一貫性を確保
  - _要件: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 1.1 ContentGenerator進捗管理のプロパティテスト
  - **Property 1: 進捗更新の単調性**
  - **Validates: Requirements 1.2, 5.2**

- [x] 1.2 ContentGeneratorフォールバック機能のプロパティテスト
  - **Property 2: フォールバック機能の確実性**
  - **Validates: Requirements 1.3, 2.3**

- [x] 2. 単一記事生成メソッドの追加
  - `generateSingleArticleWithFallback`メソッドを新規作成
  - AI生成とモック生成の切り替えロジックを実装
  - エラーハンドリングとログ記録を強化
  - _要件: 2.1, 2.3_

- [x] 2.1 単一記事生成のプロパティテスト
  - **Property 5: パラメータ渡しの正確性**
  - **Validates: Requirements 2.1, 3.1**

- [x] 3. 進捗コールバック機能の修正
  - `executeProgressCallback`メソッドを新規作成
  - コールバック実行時のエラーハンドリングを追加
  - 進捗データ形式を統一
  - _要件: 2.2_

- [x] 3.1 進捗コールバックのプロパティテスト
  - **Property 6: 進捗コールバックの実行**
  - **Validates: Requirements 2.2**

### Phase 2: SupabaseIntegration修正

- [x] 4. SupabaseIntegrationクラスのEdge Function呼び出し修正
  - `callEdgeFunctionWithRetry`メソッドを新規作成
  - リトライ機能を実装（指数バックオフ付き）
  - パラメータ形式を統一し、検証機能を追加
  - _要件: 3.1, 3.2, 3.4_

- [x] 4.1 Edge Function呼び出しのプロパティテスト
  - **Property 8: Edge Function呼び出しの正確性**
  - **Validates: Requirements 3.1**

- [x] 4.2 リトライ機能のプロパティテスト
  - **Property 9: リトライ機能の動作**
  - **Validates: Requirements 3.4**

- [x] 5. レスポンス検証機能の追加
  - `validateArticleResponse`メソッドを新規作成
  - レスポンス形式の検証とエラーハンドリング
  - データ形式の統一化
  - _要件: 3.3, 7.2_

- [x] 5.1 レスポンス検証のプロパティテスト
  - **Property 13: レスポンス処理の正確性**
  - **Validates: Requirements 4.3**

- [x] 6. モックモード切り替え機能の強化
  - 設定状態の検出ロジックを改善
  - 自動切り替え機能を強化
  - モック生成機能の安定性を向上
  - _要件: 3.5_

- [x] 6.1 モックモード切り替えのプロパティテスト
  - **Property 10: モックモード切り替えの自動性**
  - **Validates: Requirements 3.5**

### Phase 3: Edge Functions修正

- [x] 7. generate-article Edge Functionの入力検証強化
  - `validateArticleRequest`関数を新規作成
  - 入力パラメータの検証とサニタイゼーション
  - エラーレスポンス形式の統一
  - _要件: 4.1, 7.1_

- [x] 7.1 入力検証のプロパティテスト
  - **Property 11: 入力パラメータ検証の実行**
  - **Validates: Requirements 4.1**

- [x] 8. AI APIパラメータ最適化
  - プロンプト生成ロジックの改善
  - パラメータ設定の最適化
  - エラーハンドリングの強化
  - _要件: 4.2_

- [x] 8.1 AI APIパラメータのプロパティテスト
  - **Property 12: AI APIパラメータの適切性**
  - **Validates: Requirements 4.2**

- [x] 9. エラーコード判定機能の追加
  - `getErrorCode`関数を新規作成
  - エラー種別の自動判定
  - 統一されたエラーレスポンス形式
  - _要件: 4.5, 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 9.1 エラーハンドリングのプロパティテスト
  - **Property 4: エラーメッセージの適切性**
  - **Validates: Requirements 1.5, 6.1, 6.2, 6.3, 6.4, 6.5**

### Phase 4: 進捗管理機能修正

- [x] 10. ProgressManagerクラスの新規作成
  - 進捗状態の管理とUI更新機能
  - 推定時間計算機能
  - リアルタイム進捗表示の改善
  - _要件: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 10.1 進捗管理のプロパティテスト
  - **Property 16: 進捗表示の正確性**
  - **Validates: Requirements 5.3, 5.4**

- [x] 11. UI更新機能の強化
  - 進捗バー、パーセンテージ、テキスト表示の改善
  - 現在処理中記事の表示機能
  - 推定残り時間の表示機能
  - _要件: 5.2, 5.3, 5.4_

- [x] 11.1 UI更新のプロパティテスト
  - **Property 1: 進捗更新の単調性**
  - **Validates: Requirements 1.2, 5.2**

### Phase 5: エラーハンドリング統一

- [x] 12. ErrorHandlerクラスの強化
  - 統一されたエラーメッセージマップの作成
  - エラーコード自動判定機能の実装
  - ユーザーフレンドリーなメッセージ表示
  - _要件: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 12.1 エラーハンドリング統一のプロパティテスト
  - **Property 4: エラーメッセージの適切性**
  - **Validates: Requirements 1.5, 6.1, 6.2, 6.3, 6.4, 6.5**

- [x] 13. ログ機能の強化
  - 詳細なログ記録機能の実装
  - パフォーマンス情報の記録
  - デバッグ情報の充実
  - _要件: 10.1, 10.2, 10.3, 10.4, 10.5_

- [x] 13.1 ログ機能のプロパティテスト
  - **Property 15: ログ記録の実行**
  - **Validates: Requirements 4.5, 10.1, 10.2, 10.3, 10.4, 10.5**

### Phase 6: データ形式統一

- [x] 14. データ形式定義の統一
  - 記事生成リクエスト/レスポンス形式の統一
  - 進捗更新データ形式の統一
  - エラー情報形式の統一
  - _要件: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 14.1 データ形式統一のプロパティテスト
  - **Property 17: データ形式の統一性**
  - **Validates: Requirements 7.1, 7.2, 7.3, 7.4, 7.5**

- [x] 15. データ検証機能の追加
  - 入力データの検証機能
  - 出力データの検証機能
  - データ変換機能の実装
  - _要件: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 15.1 データ検証のプロパティテスト
  - **Property 3: データ永続化の一貫性**
  - **Validates: Requirements 1.4, 2.4**

### Phase 7: パフォーマンス最適化

- [x] 16. パフォーマンス監視機能の追加
  - 処理時間の測定機能
  - メモリ使用量の監視
  - リソース管理の最適化
  - _要件: 8.1, 8.2, 8.3, 8.4, 8.5_

- [x] 16.1 パフォーマンス最適化のプロパティテスト
  - **Property 18: パフォーマンス制約の遵守**
  - **Validates: Requirements 8.1, 8.2, 8.3, 8.4, 8.5**

- [x] 17. リソース管理機能の強化
  - メモリリーク防止機能
  - 適切なクリーンアップ処理
  - 同時実行数制限の実装
  - _要件: 8.3, 8.4, 8.5_

- [x] 17.1 リソース管理のプロパティテスト
  - **Property 7: クリーンアップ処理の実行**
  - **Validates: Requirements 2.5**

### Phase 8: テスト機能追加

- [x] 18. 開発者テスト機能の追加
  - 記事生成テスト機能
  - AI API接続テスト機能
  - モック生成テスト機能
  - _要件: 9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 18.1 テスト機能の単体テスト
  - 各テスト機能の動作確認
  - テスト結果の検証
  - エラーケースのテスト

- [x] 19. 統合テスト機能の追加
  - エンドツーエンドテスト
  - エラーシナリオテスト
  - パフォーマンステスト
  - _要件: 9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 19.1 統合テストの実行
  - 修正されたコンポーネント間の連携テスト
  - 記事生成フロー全体のテスト
  - エラーハンドリングの統合テスト

### Phase 9: 最終統合とテスト

- [x] 20. 全コンポーネント統合
  - 修正されたすべてのコンポーネントの統合
  - 既存機能との互換性確認
  - 後方互換性の維持
  - _要件: 全要件_

- [x] 20.1 統合テストの実行
  - 全機能の動作確認
  - エラーケースの網羅的テスト
  - パフォーマンステスト

- [x] 21. 最終チェックポイント
  - すべてのテストが通過することを確認
  - ユーザビリティテストの実行
  - ドキュメントの更新
  - _要件: 全要件_

## 注意事項

- すべてのタスクが必須実装対象
- 各タスクは要件定義書の該当要件を参照
- プロパティテストは最小100回の反復実行
- 既存機能の後方互換性を維持
- 段階的な修正により、システムの安定性を確保
- 各Phase完了後に動作確認を実施
