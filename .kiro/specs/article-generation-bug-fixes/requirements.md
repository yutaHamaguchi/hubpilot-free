# 記事生成バグ修正 - 要件定義書

## はじめに

HubPilot Free SEO記事作成エージェントの記事生成機能において、複数のバグと設計上の問題が発生しています。本ドキュメントは、これらの問題を体系的に修正し、安定した記事生成機能を実現するための要件を定義します。

## 用語集

- **記事生成エンジン**: AI APIを使用して記事コンテンツを生成するシステムコンポーネント
- **ContentGenerator**: 記事生成を担当するフロントエンドクラス
- **SupabaseIntegration**: バックエンドとの通信を担当するクラス
- **Edge Functions**: Supabaseで実行されるサーバーサイド関数
- **フォールバック機能**: AI API失敗時にモック生成に切り替える機能
- **進捗管理**: 記事生成の進行状況をリアルタイムで追跡する機能
- **エラーハンドリング**: 生成失敗時の適切な処理とユーザー通知

## 要件

### 要件1: 記事生成フローの修正

**ユーザーストーリー:** 開発者として、記事生成機能が確実に動作するように、生成フローを修正したいので、ユーザーが安定して記事を生成できます。

#### 受入基準

1. ユーザーが「記事執筆を開始」ボタンをクリックしたとき、システムは記事生成プロセスを正常に開始する必要があります
2. 記事生成中、システムは各記事の生成進捗をリアルタイムで表示する必要があります
3. AI API呼び出しが失敗した場合、システムは自動的にフォールバック機能を実行する必要があります
4. 記事生成が完了したとき、システムは生成された記事をデータストレージに保存する必要があります
5. 記事生成プロセス中にエラーが発生した場合、システムは適切なエラーメッセージを表示する必要があります

### 要件2: ContentGeneratorクラスの修正

**ユーザーストーリー:** 開発者として、ContentGeneratorクラスの記事生成ロジックを修正したいので、AI APIとの連携が正常に動作します。

#### 受入基準

1. ContentGeneratorが記事生成を開始するとき、システムは正しいパラメータでSupabaseIntegrationを呼び出す必要があります
2. 記事生成中、システムは進捗コールバック関数を正しく実行する必要があります
3. AI API呼び出しが失敗した場合、システムは例外を適切にキャッチしてフォールバック処理を実行する必要があります
4. 記事生成が完了したとき、システムは正しい形式で記事データを返す必要があります
5. 記事生成プロセスが中断された場合、システムは適切にクリーンアップ処理を実行する必要があります

### 要件3: SupabaseIntegration修正

**ユーザーストーリー:** 開発者として、SupabaseIntegrationクラスのEdge Function呼び出しを修正したいので、バックエンドとの通信が安定します。

#### 受入基準

1. SupabaseIntegrationがEdge Functionを呼び出すとき、システムは正しいパラメータ形式で送信する必要があります
2. Edge Function呼び出しが失敗した場合、システムは適切なエラーハンドリングを実行する必要があります
3. Edge Functionからのレスポンスを受信したとき、システムは正しい形式でデータを解析する必要があります
4. ネットワークエラーが発生した場合、システムは自動的にリトライ機能を実行する必要があります
5. Supabaseが未設定の場合、システムは自動的にモックモードに切り替える必要があります

### 要件4: Edge Functions修正

**ユーザーストーリー:** 開発者として、Edge Functionsの記事生成ロジックを修正したいので、AI APIとの連携が正常に動作します。

#### 受入基準

1. Edge Functionがリクエストを受信したとき、システムは入力パラメータを正しく検証する必要があります
2. AI API呼び出し時、システムは適切なプロンプトとパラメータを使用する必要があります
3. AI APIからのレスポンスを受信したとき、システムは内容を適切に処理して返す必要があります
4. 複数記事の生成時、システムは進捗状況をデータベースに正しく記録する必要があります
5. エラーが発生した場合、システムは詳細なエラー情報をログに記録する必要があります

### 要件5: 進捗管理機能の修正

**ユーザーストーリー:** ユーザーとして、記事生成の進捗状況をリアルタイムで確認したいので、生成プロセスの状況を把握できます。

#### 受入基準

1. 記事生成開始時、システムは進捗バーを0%で初期化する必要があります
2. 各記事の生成完了時、システムは進捗バーを更新する必要があります
3. 現在生成中の記事タイトルを表示するとき、システムは正確な情報を表示する必要があります
4. 生成完了記事数と残り記事数を表示するとき、システムは正確な数値を表示する必要があります
5. 記事生成が完了したとき、システムは進捗バーを100%に設定する必要があります

### 要件6: エラーハンドリングの強化

**ユーザーストーリー:** ユーザーとして、記事生成でエラーが発生した場合に適切な通知を受けたいので、問題の原因を理解し対処できます。

#### 受入基準

1. AI API接続エラーが発生した場合、システムは「AI APIに接続できません」というメッセージを表示する必要があります
2. API キー設定エラーが発生した場合、システムは「API キーの設定を確認してください」というメッセージを表示する必要があります
3. ネットワークエラーが発生した場合、システムは「ネットワーク接続を確認してください」というメッセージを表示する必要があります
4. データ保存エラーが発生した場合、システムは「データの保存に失敗しました」というメッセージを表示する必要があります
5. 予期しないエラーが発生した場合、システムは「予期しないエラーが発生しました」というメッセージを表示する必要があります

### 要件7: データ形式の統一

**ユーザーストーリー:** 開発者として、記事データの形式を統一したいので、フロントエンドとバックエンド間のデータ交換が正常に動作します。

#### 受入基準

1. 記事生成リクエスト時、システムは統一されたデータ形式でパラメータを送信する必要があります
2. 記事生成レスポンス時、システムは統一されたデータ形式で結果を返す必要があります
3. 進捗更新時、システムは統一されたデータ形式で進捗情報を送信する必要があります
4. エラー情報送信時、システムは統一されたデータ形式でエラー詳細を送信する必要があります
5. データベース保存時、システムは統一されたスキーマでデータを保存する必要があります

### 要件8: パフォーマンス最適化

**ユーザーストーリー:** ユーザーとして、記事生成が効率的に実行されることを期待するので、待機時間を最小限に抑えたいです。

#### 受入基準

1. 記事生成開始時、システムは不要な遅延なく処理を開始する必要があります
2. AI API呼び出し時、システムは適切なタイムアウト設定を使用する必要があります
3. 複数記事の並列生成時、システムは適切な同時実行数制限を設定する必要があります
4. メモリ使用量が過大にならないよう、システムは適切なリソース管理を実行する必要があります
5. 生成完了後、システムは不要なリソースを適切に解放する必要があります

### 要件9: テスト機能の追加

**ユーザーストーリー:** 開発者として、記事生成機能をテストできる機能を追加したいので、問題の早期発見と修正ができます。

#### 受入基準

1. 開発者コンソールから記事生成テストを実行できる必要があります
2. AI API接続テストを実行できる必要があります
3. モック生成機能のテストを実行できる必要があります
4. 進捗管理機能のテストを実行できる必要があります
5. エラーハンドリング機能のテストを実行できる必要があります

### 要件10: ログ機能の強化

**ユーザーストーリー:** 開発者として、記事生成プロセスの詳細なログを確認したいので、問題の原因を特定し修正できます。

#### 受入基準

1. 記事生成開始時、システムは開始ログを記録する必要があります
2. AI API呼び出し時、システムは呼び出しログを記録する必要があります
3. 記事生成完了時、システムは完了ログを記録する必要があります
4. エラー発生時、システムは詳細なエラーログを記録する必要があります
5. パフォーマンス情報として、システムは生成時間を記録する必要があります
