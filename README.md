# hubpilot-free 要件定義書

## 1. 背景・目的

- **背景**  
  - 課金サービスを展開する企業で、HubSpot 上の取引（Deal）を毎月あるいは毎年複製するニーズがある。  
  - しかし、手動での複製作業や既存機能（例：ワークフローなど）の設定作業が手間になることが多い。  
- **目的**  
  - 自動で取引を複製し、更新月や更新年の新たな取引を作成する機能を提供する。  
  - **Sales Starter でも動作する** 公開アプリを開発し、HubSpot マーケットプレイスに公開する。  
  - インストール時に最低限必要なカスタムプロパティを自動で作成し、ユーザーが手軽に導入・運用できる仕組みを提供する。

---

## 2. 前提条件・範囲

1. **HubSpotプラン**  
   - **Sales Starter** 以上を前提とし、Professional や Enterprise でも同様に動作する。  
   - HubSpot のワークフロー機能は使用しない（Starter プランではワークフローが制限されるため）。  

2. **対象オブジェクト**  
   - HubSpot の「取引（Deal）」のみを対象。  
   - 会社情報、コンタクト情報、見積もり（Quote）などは複製の対象外。  

3. **機能範囲**  
   - 月次または年次の取引複製のみ。  
   - 手動での複製は行わず、自動スケジューリングのみによって新規取引を作成する。  
   - 取引のロールバック機能は提供しない。  
   - エラー通知は HubSpot 活動履歴（アクティビティ）への記載とメール通知のみ。

4. **インフラ構成**  
   - **Firebase** をメインインフラとし、以下を想定：  
     - **Firebase Cloud Functions**：定期実行（スケジュール）や API 呼び出し等のロジック。  
     - **Firebase (Firestore/Realtime Database/Storage)**：ログや設定情報の保存先。  
   - HubSpot Public App として公開し、OAuth 認証を利用して HubSpot アカウントと連携。  

5. **UI/UX**  
   - HubSpot 既定の画面上のみでユーザーが操作する（追加のカスタム画面は作成しない）。  
   - インストール後に自動生成されるカスタムプロパティを利用して、月次/年次の設定や開始日を管理。  

---

## 3. 要求機能（Functional Requirements）

### 3.1 インストール時の処理

1. **カスタムフォルダとカスタムプロパティの作成**  
   - アプリインストール後、自動的に以下のカスタムプロパティを Deal オブジェクトに作成する。  
     1. `subpilot_type`: 「月次」または「年次」を選択するラジオボタン（2値の選択式）。  
     2. `subpilot_startdate`: 更新の開始日を記録する日付型プロパティ。  
   - カスタムプロパティは "subpilot" というフォルダ（またはグループ）にまとめる。  

### 3.2 取引複製（自動スケジュール）

1. **スケジューリングロジック**  
   - 外部（Firebase Cloud Functions 等）で定期的に実行し、HubSpot の Deals API から対象取引を取得する。  
   - ワークフロー（HubSpot 標準）等は利用せず、あくまで外部からのバッチ/スケジュール実行とする。  

2. **対象取引の特定**  
   - 下記条件を満たす取引を対象とする（詳細ロジック例）  
     - `subpilot_type` が「月次」の取引：  
       - `close date` や `subpilot_startdate` から計算した「次回更新日」が現在日付に近い、あるいは過ぎている  
     - `subpilot_type` が「年次」の取引：  
       - 同様に、1年後の更新が必要なタイミングかを判定  
   - 判定用のロジックは要件に応じて設計。（たとえば毎日 0時に Cloud Functions が走り、更新対象を取得し、複製を行う）  

3. **複製時のプロパティ設定**  
   - 既存取引と同じ主要プロパティ（Deal Name, Amount, Deal Stage など）をコピー。  
     - 「Create Date」等のシステム管理項目や履歴系のコピーは行わない。  
   - 「Close Date」は、月次の場合は +1ヶ月、年次の場合は +1年 で再設定する。  
   - 新規取引の `subpilot_type` は元取引と同じ（「月次」なら月次、「年次」なら年次）。  
   - `subpilot_startdate` は必要に応じて再計算またはコピー。  
     - 例：月次で 2025/10/05 が開始日の場合、複製された 2025/11 分の取引の `subpilot_startdate` を 2025/11/05 に更新するなど。  

4. **複製のトリガー条件**  
   - 毎日や特定時刻（例：深夜帯）などに一括実行する想定。  
   - HubSpot ワークフローは利用しない。  
   - 実行条件は Firebase Cloud Functions のスケジュール機能（cron）によって管理。  

5. **手動複製の排除**  
   - 本アプリでは手動複製は提供しない。  
   - ユーザーがボタン等で「今すぐ複製」とする機能は不要。  

### 3.3 エラー通知

1. **エラー時の活動履歴（アクティビティ）**  
   - 取引の複製に失敗した場合、その該当取引のアクティビティとしてエラーメッセージを残す。  
   - メッセージ内容には以下を含む：  
     - エラー発生時刻  
     - エラー内容（API エラー、OAuth エラーなど）  

2. **メール通知**  
   - エラー発生時は管理者（またはアプリインストール者）のメールアドレス宛に通知を送る。  
   - 通知には簡潔な失敗理由とリンク（もしくはガイドURL等）を含む。  

### 3.4 ログ管理

1. **ログの保存**  
   - Firebase（Firestore や Storage）に処理ログを保存する。  
   - 各複製処理の成否、エラー内容、日時、対象 Deal ID などを記録。  
   - 最低限、後日トラブルシュートが可能な情報を保持。  
2. **ログの閲覧**  
   - 初期フェーズでは、開発者や運用管理者のみが Firebase コンソール等で参照する想定。  
   - アプリのユーザー向けにログを閲覧する専用 UI は提供しない。  

### 3.5 ロールバック機能の非提供

1. **ロールバック（誤作成取引の一括削除等）は行わない**  
   - 大量複製に失敗した場合でも、一括削除を行う機能は提供しない。  
   - 必要であれば手動で取引を削除してもらう運用とする。  

---

## 4. 非機能要件（Non-Functional Requirements）

1. **パフォーマンス・スループット**  
   - 一度のスケジュール実行で数百〜数千件の取引を複製してもタイムアウトしないよう設計。  
   - HubSpot API の使用制限（1日あたりのリクエスト上限等）に注意し、バッチ制御やリトライ機能を実装。  

2. **セキュリティ**  
   - 公開アプリとして OAuth 認証を用い、アクセストークンおよびリフレッシュトークンを安全に管理。  
   - Firebase のセキュリティルールや、環境変数へのキー管理を適切に行う。  

3. **可用性**  
   - Firebase Cloud Functions が落ちない限り、定期実行が行われる。  
   - アプリの稼働率は Firebase SLA に準じる。  

4. **拡張性**  
   - 将来的に四半期契約などへ拡張する場合、`subpilot_type` の選択肢を追加。  
   - 追加プロパティや複雑な計算ロジックへの対応が可能なよう、コードをモジュール化。  

5. **操作性・UI/UX**  
   - HubSpot デフォルト画面で完結するため、ユーザーはカスタムプロパティを更新して運用する。  
   - 追加の設定画面やウィザードは実装しないが、ドキュメントやヘルプ記事でのガイドを提供。  

---

## 5. アーキテクチャ

1. **全体構成概要**  
   - **HubSpot**  
     - Public App (OAuth)  
     - Deals API を使用して取引の読み取り・作成。  
   - **Firebase**  
     - Cloud Functions: スケジュール（cron）処理 & API コールを行う。  
     - Firestore もしくは Realtime Database: アプリ設定・ログの保存用。  
     - (任意) Cloud Storage: 必要に応じてファイルベースのログやバックアップを置く場合に使用。  

2. **処理フロー（例）**  
   1. **Cloud Functions (スケジュール呼び出し)**  
      - 毎日または指定の時間間隔で起動。  
      - HubSpot Deals API を呼び出し、複製対象の取引を取得。  
   2. **取引複製ロジック**  
      - `subpilot_type` と `subpilot_startdate`、`close date` を確認し、必要な取引を新規に作成。  
      - 成功時：ログに処理結果を記録。  
      - 失敗時：対象取引のアクティビティにエラーメッセージを書き込み、メールを送信。  
   3. **ログ保存**  
      - Firebase Firestore（等）へ成功・失敗の情報（Deal ID、時刻、エラー内容など）を保存。  

3. **認証フロー**  
   - HubSpot Marketplace からアプリをインストール  
   - OAuth 承認画面でスコープを付与（Deals の読み書き権限等）  
   - アクセストークン・リフレッシュトークンを Firebase (Secrets Manager 等) に安全に保存し、更新管理。  

---

## 6. 運用・保守要件

1. **運用体制**  
   - エラー発生時はメールが飛ぶため、運用担当はメール通知を受け取りトラブル対応。  
   - Firebase Cloud Functions の管理・メンテナンスは開発チームまたは運用担当が行う。  

2. **保守とアップデート**  
   - HubSpot API のバージョン変更への追随（SDK アップデート等）。  
   - OAuth アプリの更新時は Marketplace への再申請が必要となる場合がある。  

3. **サポート範囲**  
   - ユーザーからの問い合わせに対し、メールやナレッジベースで対応。  
   - ログの参照や詳細調査は開発チーム/運用チームが行う。  

4. **ログ管理**  
   - Firestore / Realtime Database 等でエラーを含む全複製処理のログを保存（保持期間は要検討：例 90日）。  
   - 監査要件がある場合は、詳細なトランザクション履歴も検討。  

---

## 7. リスクと対応策

| リスク                                                     | 対応策                                                                                |
| ---------------------------------------------------------- | -------------------------------------------------------------------------------------- |
| 大量取引の複製に伴う API リミットオーバー                  | - バッチ制御（少量ずつ処理）<br>- エラーレスポンス時のリトライロジック                 |
| OAuth トークンの期限切れや無効化                           | - リフレッシュトークンの適切管理<br>- エラー時メール通知と再認証フローのガイド提供     |
| エラー通知が滞り、ユーザーが失敗を把握できない             | - 必ずアクティビティとメールの両方に通知する                                           |
| 不要な重複複製（設定ミスなど）                             | - 選定ロジックを厳密化（close date、startdate 等の整合性チェック）                     |
| ロールバック機能が無いため、一度複製された取引の削除が煩雑 | - ロールバックの非対応を明示<br>- 手動削除のガイドや注意喚起                           |
| Sales Starter でも利用できる機能か不明                     | - ワークフローを使わず、外部バッチによる自動処理のみとする                             |

---

## 8. テスト方針・テスト項目

1. **単体テスト**  
   - Cloud Functions 内のロジック：対象取引のフィルタリング・複製ロジックの正否。  
   - OAuth 認証フロー（トークン取得・更新）。  

2. **結合テスト**  
   - 実際に HubSpot サンドボックス環境と接続し、定期実行が想定通り動作するか。  
   - エラー発生時にアクティビティとメールに通知されるか。  

3. **パフォーマンステスト**  
   - 大量の取引（数千件）を複製するケースで、実行時間や API 制限を検証。  

4. **受け入れテスト（UAT）**  
   - 実際のサブスクリプションケース（例：月次契約）で翌月分が自動複製されるか。  
   - 年次契約のテストシナリオ。  

---

## 9. 今後の拡張

- **更新周期の追加**：四半期・半期など、`subpilot_type` のバリエーションを増やす。  
- **金額プロパティの自動調整**：月次や年次で金額が変動するケースの自動対応。  
- **見積もり（Quote）連動**：契約更新時に見積りを同時に発行する機能など。  
- **高度なエラーレポート画面**：ユーザーが直接ログやエラーを確認できるダッシュボードの追加。  
